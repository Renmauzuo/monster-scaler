{"version":3,"file":"global.min.js","sources":["src/scripts/global.js"],"sourcesContent":["const numberStrings = ['zero', 'one', 'two', 'three', 'four', 'five'];\r\n\r\n$(function () {\r\n\r\n    $('[data-on-change]').on('change', function () {\r\n        window[$(this).data('on-change')](true);\r\n    });\r\n\r\n    $('[data-limit]').on('change', function () {\r\n        if ($(this).val().length > $(this).data('limit')) {\r\n            $(this).val($(this).data('old-val'));\r\n        } else {\r\n            $(this).data('old-val', $(this).val());\r\n        }\r\n    });\r\n\r\n});\r\n \r\n/**\r\n * Shows or hides the variant dropdown based on the current monster, and populates it with any variant options.\r\n *\r\n * @param {boolean} animated Whether or not to animate the show/hide\r\n */\r\nfunction setupVariantSelect(animated) {\r\n    let animationDuration = animated ? 400 : 0;\r\n    let monsterID = $('#creature').val();\r\n    let selectedMonster = monsterList[monsterID];\r\n    if (selectedMonster.variants) {\r\n        $('#variant').empty();\r\n        for (let variant in selectedMonster.variants) {\r\n            $('<option value='+variant+'>'+selectedMonster.variants[variant].name+'</option>').appendTo('#variant');\r\n        }\r\n        $('#variant-wrapper').fadeIn(animationDuration);\r\n    } else {\r\n        $('#variant-wrapper').fadeOut(animationDuration);\r\n    }\r\n\r\n    if (selectedMonster.type === typeHumanoid && selectedMonster.race === raceAny) {\r\n        $('#race-wrapper').fadeIn(animationDuration);\r\n    } else {\r\n        $('#race-wrapper').fadeOut(animationDuration);\r\n    }\r\n}\r\n\r\n/**\r\n * Scales the target creature to desired challenge rating. Optionally takes a dictionary of options to customize the creature further.\r\n *\r\n * @param {string} monsterID The ID (from data.js) of the mosnter to scale\r\n * @param {string} targetCR The target CR. Must be a string, not a number.\r\n * @param {Object} [options] Dictionary of options to customize the statblock\r\n * @param {string} [options.variant] ID of the chosen variant if this creature has them\r\n * @param {string} [options.race] The current race if the creature is a humanoid and of an \"any race\" NPC type\r\n * @return {Object} The scaled and modified statblock for the target creature\r\n */\r\nfunction scaleMonster(monsterID, targetCR, options = {}) {\r\n    let selectedMonster = monsterList[monsterID];\r\n    let numTargetCR = Number(targetCR); //Certain comparisons require a numeric version of the CR\r\n    let selectedVariant;\r\n    if (selectedMonster.variants) {\r\n        selectedVariant = selectedMonster.variants[options.variant];\r\n    }\r\n\r\n    //Need to combine variant stats with base stats, if applicable\r\n    let sourceStats = Object.assign({}, selectedMonster.stats);\r\n    if (selectedVariant && selectedVariant.stats) {\r\n        for (let cr in selectedVariant.stats) {\r\n            if (sourceStats[cr]) {\r\n                sourceStats[cr] = mergeObjects(sourceStats[cr], selectedVariant.stats[cr]);\r\n            } else {\r\n                sourceStats[cr] = selectedVariant.stats[cr];\r\n            }\r\n        }\r\n    }\r\n\r\n    //Start with locked stats and presets for this CR, if any\r\n    let derivedStats = {};\r\n\r\n    derivedStats.cr = targetCR;\r\n    derivedStats.gender = selectedMonster.gender || 4; //Default to genderless\r\n    \r\n    if (sourceStats[targetCR]) {\r\n        derivedStats = mergeObjects(derivedStats, sourceStats[targetCR]);\r\n    }\r\n    derivedStats = mergeObjects(derivedStats, selectedMonster.lockedStats);\r\n    if (selectedVariant && selectedVariant.lockedStats) {\r\n        derivedStats = mergeObjects(derivedStats, selectedVariant.lockedStats);\r\n    }\r\n    let currentRace;\r\n    if (selectedMonster.type === typeHumanoid) {\r\n        if (selectedMonster.race === raceAny) {\r\n            currentRace = races[options.race];\r\n            derivedStats.type = selectedMonster.type + ' (' + currentRace.name + ')';\r\n\r\n            //If not any race apply the mods for the chosen race\r\n            if (currentRace !== races[0]) {\r\n                derivedStats = mergeObjects(derivedStats, currentRace.stats);\r\n\r\n                //If the NPC gets languages for their race deduct them from any \"bonus languages\"\r\n                if (derivedStats.extraLanguages && currentRace.stats.languages) {\r\n                    derivedStats.extraLanguages -= currentRace.stats.languages.length;\r\n                    derivedStats.extraLanguages = Math.max(derivedStats.extraLanguages, 0); //Make sure it's not negative\r\n                }\r\n            }\r\n\r\n        } else {\r\n            derivedStats.type = selectedMonster.type + ' (' + selectedMonster.type + ')';\r\n        }\r\n    } else {\r\n        derivedStats.type = selectedMonster.type;\r\n        if (selectedMonster.subtype) {\r\n            derivedStats.type += ' (' + selectedMonster.subtype + ')';\r\n        }\r\n        $('#race-wrapper').hide();\r\n    }\r\n\r\n    derivedStats.proficiency = averageStats[targetCR].proficiency;\r\n    \r\n    //Store some strings in derived stats so they are available outside this scope\r\n    derivedStats.alignment = selectedMonster.alignment;\r\n\r\n\r\n    //Once we have our locked stats, go through the rest of the states to interpolate or extrapolate based on existing values.\r\n    //All of the preset monster statblocks should be complete, but if we ever add \"keyframes\" for individual stats it may be possible to have CRs without all stats for a template\r\n    //For this reason we do the interpolation for EACH stat individually, rather than finding the closest statblock to draw from\r\n\r\n    //Grab the most appropriate name if this CR doesn't have one\r\n    if (!derivedStats.name) {\r\n        derivedStats.name = findNearestLowerBenchmark(\"name\", targetCR, sourceStats);\r\n    }\r\n\r\n    if(!derivedStats.slug) {\r\n        derivedStats.slug = findNearestLowerBenchmark(\"slug\", targetCR, sourceStats);\r\n    }\r\n    derivedStats.appearance = derivedStats.slug; //TODO: Updated for creatures where appearance isn't slug (ie, treants are trees)\r\n    //Description for traits. The creature's proper name if it has one, otherwise \"the [slug]\"\r\n    derivedStats.description = (derivedStats.unique ? derivedStats.name : 'the ' + derivedStats.slug);\r\n\r\n    //Traits require a different approach from some other stats as we take a base from the trait library, but potentially apply modifiers to it based on creature stats.\r\n    //TODO: Adjust for creatures that gain additional traits as they level up\r\n    let lockedTraits = derivedStats.traits;\r\n    derivedStats.traits = {};\r\n    let traitList = [];\r\n    if (selectedMonster.traits) {\r\n        traitList = traitList.concat(selectedMonster.traits);\r\n    }\r\n    if (selectedVariant && selectedVariant.traits) {\r\n        traitList = traitList.concat(selectedVariant.traits); \r\n    }\r\n    if (currentRace && currentRace.traits) {\r\n        traitList = traitList.concat(currentRace.traits);\r\n    }\r\n    for (let i = 0; i < traitList.length; i++) {\r\n        derivedStats.traits[traitList[i]] = generateTrait(traitList[i], targetCR, sourceStats);\r\n    }\r\n    //Overwrite with any locked attributes (such as spell list)\r\n    if (lockedTraits) {\r\n        derivedStats.traits = mergeObjects(derivedStats.traits, lockedTraits);\r\n    }\r\n\r\n    //Actions are handled somewhat like traits, although at this time there are no additional ones from race or variant\r\n    if (selectedMonster.actions) {\r\n        derivedStats.actions = {};\r\n        for (let i = 0; i < selectedMonster.actions.length; i++) {\r\n            derivedStats.actions[selectedMonster.actions[i]] = generateTrait(selectedMonster.actions[i], targetCR, sourceStats);\r\n        }\r\n    }\r\n    if (selectedMonster.bonusActions) {\r\n        derivedStats.bonusActions = {};\r\n        for (let i = 0; i < selectedMonster.bonusActions.length; i++) {\r\n            derivedStats.bonusActions[selectedMonster.bonusActions[i]] = generateTrait(selectedMonster.bonusActions[i], targetCR, sourceStats);\r\n        }\r\n    }\r\n\r\n    if(!derivedStats.size) {\r\n        let sizeBenchmarks = findBenchmarksForStat(\"size\", targetCR, sourceStats);\r\n        derivedStats.size = extrapolateFromBenchmark(\"size\", targetCR, sizeBenchmarks, true);\r\n        derivedStats.size = Math.min(6, derivedStats.size);\r\n    }\r\n\r\n    derivedStats.abilityModifiers = {};\r\n    for (let ability in abilities) {\r\n        if (!derivedStats[ability]) {\r\n            let abilityBenchmarks = findBenchmarksForStat(ability, targetCR, sourceStats);\r\n            derivedStats[ability] = extrapolateFromBenchmark(ability, targetCR, abilityBenchmarks, false);\r\n        }\r\n        derivedStats.abilityModifiers[ability] = abilityScoreModifier(derivedStats[ability]);\r\n    }    \r\n\r\n    //Need to check vs undefined rather than do implicit cast to acocunt for cases where bonus armor is already derived as 0\r\n    if (derivedStats.bonusArmor == undefined) {\r\n        /* \r\n        * CR is more concerned with derived stats like total AC than source stats like armor bonus\r\n        * So instead of extrapolating the armor bonus on its own we extrapolate total AC then reverse engineer armor bonus based on other AC mods\r\n        * This also solves the problem of average natural armor by CR being hard to calculate, since many creatures don't have natural armor.\r\n        */\r\n        let acBenchmarks = findBenchmarksForStat([\"bonusArmor\", \"dex\"], targetCR, sourceStats);\r\n        //Creature may not have bonus armor at all, in which case we skip this step\r\n        if (acBenchmarks) {\r\n            for (let benchmark in acBenchmarks) {\r\n                //5e is sometimes vague about monster stat calculations, so for simplicity we assume all bonus armor allows the full dex modifier\r\n                acBenchmarks[benchmark].ac = 10 + acBenchmarks[benchmark].bonusArmor + abilityScoreModifier(acBenchmarks[benchmark].dex);\r\n            }\r\n            let targetAC = extrapolateFromBenchmark('ac', targetCR, acBenchmarks, false);\r\n            //The max check shouldn't really be necessary, but we don't want to risk a creature with abnormally high dex resulting in a negative bonus armor rating\r\n            derivedStats.bonusArmor = Math.max(0, targetAC - 10 - derivedStats.abilityModifiers.dex);\r\n        } else {\r\n            derivedStats.bonusArmor = 0; //Need to define it to add wild shape bonus to it\r\n        }\r\n    }\r\n\r\n    if (!derivedStats.hitDice) {\r\n        //Like AC bonuses, we calculate hit dice by extrapolating a target HP number and working backwards rather than extrapolating hit dice directly\r\n        let hpStats = [\"con\", \"hitDice\"];\r\n        //Don't search for size for humanoids as their size is locked (and will cause an error)\r\n        if (!selectedMonster.lockedStats.size) {\r\n            hpStats.push(\"size\");\r\n        }\r\n        let hpBenchmarks = findBenchmarksForStat(hpStats, targetCR, sourceStats);\r\n        for (let benchmark in hpBenchmarks) {\r\n            let currentBenchmark = hpBenchmarks[benchmark];\r\n            if (!currentBenchmark.size) {\r\n                currentBenchmark.size = derivedStats.size;\r\n            }\r\n            currentBenchmark.hp = Math.floor(hitPointsPerHitDie(currentBenchmark) * currentBenchmark.hitDice);\r\n        }\r\n        let targetHP = extrapolateFromBenchmark('hp', targetCR, hpBenchmarks, false);\r\n        let hpPerHD = hitPointsPerHitDie(derivedStats);\r\n        derivedStats.hitDice = Math.max(1, Math.round(targetHP / hpPerHD));\r\n    }\r\n\r\n    //Find all attacks the creature should have at the target CR by adding attacks for all CRs equal to or below target\r\n    for (let cr in sourceStats) {\r\n        if (parseFloat(cr) <= parseFloat(targetCR) && sourceStats[cr].attacks) {\r\n            for (let attack in sourceStats[cr].attacks) {\r\n                if (!derivedStats.attacks[attack]) {\r\n                    //We want to copy the attack except for its damage, as that may need to be adjusted based on CR\r\n                    let attackCopy = Object.assign({}, sourceStats[cr].attacks[attack]);\r\n                    delete attackCopy.damageDice;\r\n                    delete attackCopy.damageDieSize;\r\n                    derivedStats.attacks[attack] = attackCopy;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    for (let attack in derivedStats.attacks) {\r\n        let currentAttack = derivedStats.attacks[attack];\r\n        //Ensure we are using appropriate stats for the target CR, if they are present\r\n        if (sourceStats[targetCR] && sourceStats[targetCR].attacks && sourceStats[targetCR].attacks[attack]) {\r\n            derivedStats.attacks[attack] = Object.assign(derivedStats.attacks[attack], sourceStats[targetCR].attacks[attack]);\r\n        }\r\n\r\n        //Fill in the gaps by extrapolating any missing attributes (such as attack damage)\r\n        if (!currentAttack.damageDice) {\r\n            let damageDiceString = 'attacks__'+attack+'__damageDice';\r\n            let damageDieString =  'attacks__'+attack+'__damageDieSize';\r\n            let attributes = ['str', damageDiceString, damageDieString];\r\n            if (currentAttack.finesse) {\r\n                attributes.push('dex');\r\n            }\r\n            let damageBenchmarks = findBenchmarksForStat(attributes, targetCR, sourceStats);\r\n            for (let benchmark in damageBenchmarks) {\r\n                let currentBenchmark = damageBenchmarks[benchmark];\r\n                currentBenchmark.damagePerRound = averageRoll(currentBenchmark[damageDiceString], currentBenchmark[damageDieString]);\r\n                currentBenchmark.damagePerRound +=  abilityScoreModifier(currentAttack.finesse ? Math.max(currentBenchmark.str, currentBenchmark.dex) : currentBenchmark.str);\r\n            }\r\n            let estimatedDamage = extrapolateFromBenchmark('damagePerRound', targetCR, damageBenchmarks, false);\r\n            let targetDamage = estimatedDamage - (currentAttack.finesse ? Math.max(derivedStats.abilityModifiers.str, derivedStats.abilityModifiers.dex) : derivedStats.abilityModifiers.str);\r\n            //console.log(targetDamage);\r\n            let preferredDieSize = findNearestLowerBenchmark(damageDieString, targetCR, sourceStats);\r\n            let estimatedDice = findDamageDice(targetDamage, preferredDieSize);\r\n            currentAttack.damageDice = estimatedDice[0];\r\n            currentAttack.damageDieSize = estimatedDice[1];\r\n        }\r\n\r\n        if (currentAttack.ranged && !currentAttack.range) {\r\n            currentAttack.range = findNearestLowerBenchmark('attacks__'+attack+'__range', targetCR, sourceStats);\r\n            currentAttack.longRange = findNearestLowerBenchmark('attacks__'+attack+'__longRange', targetCR, sourceStats);\r\n        }\r\n\r\n        //This could possibly be made into a function to share logic with the block above, but this one is a little difference since it doesn't include ability score bonuses\r\n        if (currentAttack.damageRiderType && !currentAttack.damageRiderDice) {\r\n            let damageDiceString = 'attacks__'+attack+'__damageRiderDice';\r\n            let damageDieSizeString =  'attacks__'+attack+'__damageRiderDieSize';\r\n            \r\n            let estimatedDice = scaleDamageRoll(damageDiceString, damageDieSizeString, targetCR, sourceStats);\r\n            currentAttack.damageRiderDice = estimatedDice[0];\r\n            currentAttack.damageRiderDieSize = estimatedDice[1];\r\n        }\r\n\r\n        if (currentAttack.proc) {\r\n            currentAttack.generatedProc = generateTrait(currentAttack.proc, targetCR, sourceStats);\r\n        }\r\n    }\r\n\r\n    if (!derivedStats.multiattack) {\r\n        //See if the creature gains multiattack as it goes up in CR\r\n        for (let cr in sourceStats) {\r\n            let numCR = Number(cr);\r\n            let highestCR = 0;\r\n            if (numCR <= numTargetCR && numCR > highestCR && sourceStats[cr].multiattack) {\r\n                highestCR = numCR;\r\n                derivedStats.multiattack = sourceStats[cr].multiattack;\r\n            }\r\n        }\r\n    }\r\n\r\n    //Add racial bonuses\r\n    //These are added near the end so they don't affect other calculations\r\n    //ie, a dwarf thug should not end up with fewer HD than a human thug because of their HP bonuses\r\n    if (selectedMonster.type === typeHumanoid && selectedMonster.race === raceAny && currentRace !== races[0]) {\r\n        for (let stat in currentRace.bonusStats) {\r\n            derivedStats[stat] += currentRace.bonusStats[stat];\r\n            //This does mean we need to recalculate the modifier\r\n            derivedStats.abilityModifiers[stat] = abilityScoreModifier(derivedStats[stat]);\r\n        }\r\n    }\r\n\r\n\r\n    //Calculate movement speeds. These won't scale with CR, we just take the stat the stat from the closest lower CR.\r\n    derivedStats.speed = findNearestLowerBenchmark('speed', targetCR, sourceStats);\r\n    derivedStats.swim = findNearestLowerBenchmark('swim', targetCR, sourceStats);\r\n    derivedStats.climb = findNearestLowerBenchmark('climb', targetCR, sourceStats);\r\n    derivedStats.burrow = findNearestLowerBenchmark('burrow', targetCR, sourceStats);\r\n    derivedStats.fly = findNearestLowerBenchmark('fly', targetCR, sourceStats);\r\n\r\n    //Determine what senses the creature should have\r\n    for (let i = 0; i < senses.length; i++) {\r\n        let sense = senses[i];\r\n        if (!derivedStats[sense]) {\r\n            derivedStats[sense] = findNearestLowerBenchmark(sense, targetCR, sourceStats);\r\n        }\r\n    }\r\n\r\n    return derivedStats;\r\n}\r\n\r\n/**\r\n * Takes a stablock object and renders it to the stablock div on screen\r\n * Some of the strings this function generates are also used by the FightClub export, but as we always populate the statblock for any creature you can export this is ok (for now)\r\n * TODO: Rework this to support multiple statblocks by replacing classes with IDs and taking the desired statblock as a param\r\n * \r\n * @param {Object} sourceStats The statblock to display\r\n */\r\nfunction renderStatblock(sourceStats) {\r\n    //Create a list of spells available to the creature (via spellcasting, innate spellcasting, or spell like abilities) in case any affect the stateblock\r\n    let availableSpells = [];   \r\n    for (let traitName in sourceStats.traits) {\r\n        let trait = sourceStats.traits[traitName];\r\n        if (trait.spellList) {\r\n            for (let spell in trait.spellList) {\r\n                availableSpells.push(spell);\r\n            }\r\n        }\r\n    }\r\n\r\n    //If this is a wildshape we show their name, but also what type of creature this form is in parenthesis. This makes it easier for shapeshifters to track multiple stat blocks.\r\n    $('#monster-name').html((sourceStats.wildShape && sourceStats.defaultName !== sourceStats.name) ? (sourceStats.name + ' (' + sourceStats.defaultName + ')') : sourceStats.name);\r\n    $('#monster-type').html(sizes[sourceStats.size].name + ' ' + sourceStats.type + ', ' + sourceStats.alignment);\r\n\r\n    let armorDescription;\r\n    let acTotal;\r\n    if (sourceStats.armor) {\r\n        let armor = armorTypes[sourceStats.armor];\r\n        armorDescription = armor.name || toSentenceCase(sourceStats.armor);\r\n        acTotal = armor.ac;\r\n        if (armor.type === armorTypeLight) {\r\n            acTotal += sourceStats.abilityModifiers.dex;\r\n        } else if (armor.type === armorTypeMedium) {\r\n            acTotal += Math.max(sourceStats.abilityModifiers.dex, 2);\r\n        }\r\n    } else {\r\n        acTotal = 10 + sourceStats.abilityModifiers.dex;\r\n    }\r\n\r\n    if (sourceStats.bonusArmor) {\r\n        acTotal += sourceStats.bonusArmor;\r\n\r\n        //Only add an armor description if we didn't already get one from worn armor\r\n        if (!armorDescription) {\r\n            armorDescription = sourceStats.armorDescription || 'Bonus Armor';\r\n        }\r\n    }\r\n    let armorString = acTotal + (armorDescription ? ' (' + armorDescription +')' : '');\r\n    if (acTotal < 16 && availableSpells.includes('barkskin')) {\r\n        armorString+= ' (16 with barkskin)';\r\n    }\r\n    $('#armor-class span').html(armorString);\r\n\r\n    //Dwarves make HP more complicated\r\n    let bonusHP = sourceStats.abilityModifiers.con * sourceStats.hitDice;\r\n    //Dwarven toughness is only added here so it doesn't change the hit dice of dwarf NPCs\r\n    for (let traitName in sourceStats.traits) {\r\n        let trait = sourceStats.traits[traitName];\r\n        if (trait.hitPointsPerHitDie) {\r\n            bonusHP += trait.hitPointsPerHitDie * sourceStats.hitDice;\r\n        }\r\n    }\r\n    $('#hit-points span').html(damageString(sourceStats.hitDice, sizes[sourceStats.size].hitDie, bonusHP));\r\n\r\n    let speedString = \"\";\r\n    if (sourceStats.speed) {\r\n        speedString = sourceStats.speed + ' ft.';\r\n    }\r\n    if (sourceStats.swim) {\r\n        speedString += (speedString.length ? ', ' : '') + \"Swim \" + sourceStats.swim + ' ft.';\r\n    }\r\n    if (sourceStats.climb) {\r\n        speedString += (speedString.length ? ', ' : '') + \"Climb \" + sourceStats.climb + ' ft.';\r\n    }\r\n    if (sourceStats.burrow) {\r\n        speedString += (speedString.length ? ', ' : '') + \"Burrow \" + sourceStats.burrow + ' ft.';\r\n    }\r\n    if (sourceStats.fly) {\r\n        speedString += (speedString.length ? ', ' : '') + \"Fly \" + sourceStats.fly + ' ft.';\r\n    }\r\n    $('#speed span').html(speedString);\r\n\r\n    for (let ability in abilities) {\r\n        let modifier = abilityScoreModifier(sourceStats[ability]);\r\n        let modifierString = \"(\" + (modifier >= 0 ? '+' : '') + modifier + \")\";\r\n       $('#monster-'+ability).html(sourceStats[ability] + \" \" + modifierString);\r\n    }\r\n\r\n    if (sourceStats.saves) {\r\n        $('#saving-throws').show();\r\n        let saveString = \"\";\r\n        for (let i = 0; i < sourceStats.saves.length; i++) {\r\n            let save = sourceStats.saves[i];\r\n            if (saveString.length) {\r\n                saveString += ', ';\r\n            }\r\n            let saveModifier = sourceStats.proficiency + sourceStats.abilityModifiers[save];\r\n            let modifierString = (saveModifier >= 0 ? '+' : '') + saveModifier;\r\n            saveString+= abilities[save].name + ' ' + modifierString;\r\n        }\r\n        $('#saving-throws span').html(saveString);\r\n    } else {\r\n        $('#saving-throws').hide();\r\n    }\r\n\r\n    //TODO: When we add homebrow monsters we may need to account for creatures that gain new skills as they go up in CR.\r\n    if (sourceStats.skills) {\r\n        $('#skills').show();\r\n        let skillString = \"\";\r\n        for (let skill in sourceStats.skills) {\r\n            if (skillString.length) {\r\n                skillString += ', ';\r\n            }\r\n            let skillModifier = sourceStats.proficiency*sourceStats.skills[skill] + sourceStats.abilityModifiers[skills[skill].ability];\r\n            let modifierString = (skillModifier >= 0 ? '+' : '') + skillModifier;\r\n            skillString+= (skills[skill].name || toSentenceCase(skill)) + ' ' + modifierString;\r\n        }\r\n        $('#skills span').html(skillString);\r\n    } else {\r\n        $('#skills').hide();\r\n    }\r\n\r\n    if (sourceStats.vulnerabilities) {\r\n        let vulnerabilitiesString = \"\";\r\n        for (let i = 0; i < sourceStats.vulnerabilities.length; i++) {\r\n            if (i) {\r\n                vulnerabilitiesString += ', ';\r\n            }\r\n            vulnerabilitiesString += toSentenceCase(sourceStats.vulnerabilities[i]);\r\n        }\r\n        $('#vulnerabilities span').html(vulnerabilitiesString);\r\n        $('#vulnerabilities').show();\r\n    } else {\r\n        $('#vulnerabilities').hide();\r\n    }\r\n\r\n    if (sourceStats.resistances) {\r\n        let resistancesString = \"\";\r\n        for (let i = 0; i < sourceStats.resistances.length; i++) {\r\n            if (i) {\r\n                resistancesString += ', ';\r\n            }\r\n            resistancesString += toSentenceCase(sourceStats.resistances[i]);\r\n        }\r\n        $('#resistances span').html(resistancesString);\r\n        $('#resistances').show();\r\n    } else {\r\n        $('#resistances').hide();\r\n    }\r\n\r\n    if (sourceStats.immunities) {\r\n        let immunitiesString = \"\";\r\n        for (let i = 0; i < sourceStats.immunities.length; i++) {\r\n            if (i) {\r\n                immunitiesString += ', ';\r\n            }\r\n            immunitiesString += toSentenceCase(sourceStats.immunities[i]);\r\n        }\r\n        $('#immunities span').html(immunitiesString);\r\n        $('#immunities').show();\r\n    } else {\r\n        $('#immunities').hide();\r\n    }\r\n\r\n    if (sourceStats.conditionImmunities) {\r\n        let conditionImmunitiesString = \"\";\r\n        for (let i = 0; i < sourceStats.conditionImmunities.length; i++) {\r\n            if (i) {\r\n                conditionImmunitiesString += ', ';\r\n            }\r\n            conditionImmunitiesString += toSentenceCase(sourceStats.conditionImmunities[i]);\r\n        }\r\n        $('#condition-immunities span').html(conditionImmunitiesString);\r\n    } else {\r\n        $('#condition-immunities').hide();\r\n    }\r\n\r\n    let sensesString = \"\";\r\n    for (let i = 0; i < senses.length; i++) {\r\n        let sense = senses[i];\r\n        if (sourceStats[sense]) {\r\n            sensesString += sensesString.length ? ', ' : '';\r\n            sensesString += sense + \" \" + sourceStats[sense] + ' ft.'\r\n        }\r\n    }\r\n\r\n    sourceStats.sensesString = sensesString; //Need to store this without passive perception added as Fight Club tracks that separately\r\n    sensesString += sensesString.length ? ', ' : '';\r\n    sourceStats.passivePerception = (10 + sourceStats.abilityModifiers.wis + (sourceStats.skills && sourceStats.skills.hasOwnProperty('perception') ? sourceStats.proficiency : 0));\r\n    sensesString += 'passive Perception ' + sourceStats.passivePerception;\r\n    $('#senses span').html(sensesString);\r\n\r\n    $('#challenge-rating span').html(sourceStats.cr ? stringForCR(sourceStats.cr) + ' (' + averageStats[sourceStats.cr].xp.toLocaleString() + ' XP)' : '&mdash;');\r\n\r\n    $('#traits').empty();\r\n    if (sourceStats.traits) {\r\n        for (let traitName in sourceStats.traits) {\r\n            let currentTrait = sourceStats.traits[traitName];\r\n            currentTrait.text = replaceTokensInString(currentTrait.description, sourceStats, currentTrait); //save the output text for Fight Club\r\n            $('<p><strong><em>'+currentTrait.name+'.</em></strong> '+currentTrait.text+'</p>').appendTo('#traits');\r\n        }\r\n    }\r\n\r\n    if (sourceStats.extraLanguages) {\r\n        sourceStats.languages = sourceStats.languages || [];\r\n        sourceStats.languages.push(\"any \" + numberStrings[sourceStats.extraLanguages] + ' language' + (sourceStats.extraLanguages === 1 ? ' (usually Common)' : ''));\r\n    }\r\n    if (sourceStats.languages) {\r\n        let languagesString = \"\";\r\n        for (let i = 0; i < sourceStats.languages.length; i++) {\r\n            if (i) {\r\n                languagesString += ', ';\r\n            }\r\n            languagesString += sourceStats.languages[i];\r\n        }\r\n        $('#languages span').html(languagesString).show();\r\n    } else {\r\n        $('#languages').hide();\r\n    }\r\n\r\n    $('#attacks').empty();\r\n    if (sourceStats.multiattack) {\r\n        let multiattackString;\r\n        if (Object.keys(sourceStats.multiattack.attacks).length > 1) {\r\n            //Text reads differently if there are multiple different attack types\r\n            let attackCount = 0;\r\n            multiattackString = \"\";\r\n            let attacks = Object.keys(sourceStats.multiattack.attacks);\r\n            for (let i = 0; i < attacks.length; i++) {\r\n                attackCount += sourceStats.multiattack.attacks[attacks[i]];\r\n                multiattackString += numberStrings[sourceStats.multiattack.attacks[attacks[i]]] + ' with its ' + sourceStats.attacks[attacks[i]].name.toLowerCase();\r\n                if (i < attacks.length - 2) {\r\n                    //Separate attacks with commas\r\n                    multiattackString += ', ';\r\n                } else if (i == attacks.length - 2) {\r\n                    //Add \"and\" before last attack. Add an oxford comma, but only if there are more than two types of attacks.\r\n                    multiattackString += (attacks.length > 2 ? ',' : '') + ' and ';\r\n                }\r\n            }\r\n            multiattackString = toSentenceCase(sourceStats.description) + ' makes ' + numberStrings[attackCount] + ' attacks:' + multiattackString + '.';\r\n            if (sourceStats.multiattack.requireDifferentTargets) {\r\n                //This may need to change if a creature with more than two attacks ever gets this attribute, but for now it's fine as is as only the t rex has this restriction\r\n                multiattackString+= ' It can&rsquo;t make both attacks against the same target.';\r\n            }\r\n        } else {\r\n            let attack = Object.keys(sourceStats.multiattack.attacks)[0];\r\n            multiattackString = toSentenceCase(sourceStats.description) + ' makes ' + numberStrings[sourceStats.multiattack.attacks[attack]] + ' ' + sourceStats.attacks[attack].name.toLowerCase() + ' attacks.';\r\n        }\r\n        //Store the string for fight club\r\n        sourceStats.multiattackString = multiattackString;\r\n        $('<p><strong>Multiattack:</strong>'+multiattackString+'</p>').appendTo('#attacks');\r\n        \r\n    }\r\n    if (sourceStats.attacks) {\r\n        for (let attack in sourceStats.attacks) {\r\n            let currentAttack = sourceStats.attacks[attack];\r\n            let abilityModifier;\r\n            if (currentAttack.finesse) {\r\n                abilityModifier = Math.max(sourceStats.abilityModifiers.str, sourceStats.abilityModifiers.dex);\r\n            } else if (currentAttack.spellAttack) {\r\n                abilityModifier = sourceStats.abilityModifiers[sourceStats.castingStat];\r\n            } else {\r\n                abilityModifier = sourceStats.abilityModifiers.str;\r\n            }\r\n            let shillelagh = false;\r\n            if (availableSpells.includes('shillelagh') && attack === 'club' || attack ==='quarterstaff') {\r\n                shillelagh = true;\r\n            }\r\n\r\n            //Save some things for Fight Club export\r\n            currentAttack.attackBonus = sourceStats.proficiency + abilityModifier;\r\n            currentAttack.damageBonus = abilityModifier;\r\n            if (sourceStats.wildShape) {\r\n                //TODO: Handle these differently\r\n                currentAttack.attackBonus += parseInt($('#ws-attack-bonus').val());\r\n                currentAttack.damageBonus += parseInt($('#ws-damage-bonus').val());\r\n            }\r\n            if (currentAttack.enhancement) {\r\n                currentAttack.attackBonus += currentAttack.enhancement;\r\n                currentAttack.damageBonus += currentAttack.enhancement;\r\n            }\r\n            \r\n            let attackString = '<em>' + (currentAttack.ranged ? 'Ranged' : 'Melee') + ' ' + (currentAttack.spellAttack ? 'Spell' : 'Weapon') + ' Attack:</em> ';\r\n            let rangeString;\r\n            if (currentAttack.ranged) {\r\n                rangeString = 'range ' + currentAttack.range + (currentAttack.longRange ? '/' + currentAttack.longRange : '');\r\n            } else {\r\n                rangeString = 'reach ' + sizes[sourceStats.size].reach[currentAttack.reach];\r\n            }\r\n            //Monster stat blocks never have negative to hit, so we set 0 as the minimum\r\n            attackString += '+' + Math.max(currentAttack.attackBonus, 0) + ' to hit';\r\n            if(shillelagh) {\r\n                attackString += ' (+' + (sourceStats.proficiency + sourceStats.abilityModifiers[sourceStats.castingStat]) + ' to hit with shillelagh)';\r\n            }\r\n\r\n            attackString += ', ' + rangeString+ ' ft., ';\r\n            if (currentAttack.proneOnly) {\r\n                attackString += 'one prone creature';\r\n            } else if (currentAttack.creatureOnly) {\r\n                attackString += 'one creature;'\r\n            } else {\r\n                attackString += 'one target';\r\n            }\r\n            attackString += (currentAttack.notGrappled ? ' not grappled by ' + sourceStats.description : '') + '. '\r\n            attackString += '<em>Hit:</em> ' + Math.max(1, (averageRoll(currentAttack.damageDice, currentAttack.damageDieSize) + currentAttack.damageBonus));\r\n            let maxDamage = currentAttack.damageDice * currentAttack.damageDieSize + currentAttack.damageBonus;\r\n            //If the attack can't do more than one damage total omit the roll and just show 1 flat damage\r\n            if (maxDamage > 1) {\r\n                attackString += ' (' + currentAttack.damageDice + 'd' + currentAttack.damageDieSize;\r\n                if (currentAttack.damageBonus) {\r\n                    attackString += (currentAttack.damageBonus >= 0 ? ' + ' : ' - ' ) + Math.abs(currentAttack.damageBonus);\r\n                }\r\n                attackString += ')';\r\n            }\r\n\r\n            attackString += ' ' +  currentAttack.damageType + ' damage';\r\n\r\n            if (shillelagh) {\r\n                attackString += ', or ' + damageString(currentAttack.damageDice, 8, sourceStats.abilityModifiers[sourceStats.castingStat]) + ' with shillelagh'\r\n            }\r\n\r\n            //Add riders and procs\r\n            if (currentAttack.damageRiderDice) {\r\n                attackString += ' plus ' + damageString(currentAttack.damageRiderDice, currentAttack.damageRiderDieSize) + ' ' + currentAttack.damageRiderType + ' damage';\r\n            }\r\n            let wsRiderDice = parseInt($('#ws-rider-dice').val());\r\n            if (sourceStats.wildShape && wsRiderDice) {\r\n                attackString += ' plus ' + damageString(wsRiderDice, parseInt($('#ws-rider-die-size').val())) + ' ' + $('#ws-rider-type').val() + ' damage';\r\n            } \r\n            attackString += '.';\r\n            if (currentAttack.generatedProc) {\r\n                attackString+= ' ' + replaceTokensInString(currentAttack.generatedProc.description, sourceStats, currentAttack.generatedProc);\r\n            }\r\n            currentAttack.text = attackString; //Save text for Fight Club\r\n            $('<p><strong>'+(currentAttack.name||toSentenceCase(attack))+'</strong> '+attackString+'</p>').appendTo('#attacks');\r\n        }\r\n    }\r\n\r\n    if (sourceStats.actions) {\r\n        for (let actionName in sourceStats.actions) {\r\n            let currentAction = sourceStats.actions[actionName];\r\n            currentAction.text = replaceTokensInString(currentAction.description, sourceStats, currentAction); //save the output text for Fight Club\r\n            $('<p><strong><em>'+currentAction.name+'.</em></strong> '+currentAction.text+'</p>').appendTo('#attacks');\r\n        }\r\n    }\r\n\r\n    if (sourceStats.bonusActions) {\r\n        $('#bonus-actions').empty();\r\n        $('#bonus-actions-wrapper').show();\r\n        for (let bonusActionName in sourceStats.bonusActions) {\r\n            let currentBonusAction = sourceStats.bonusActions[bonusActionName];\r\n            currentBonusAction.text = replaceTokensInString(currentBonusAction.description, sourceStats, currentBonusAction); //save the output text for Fight Club\r\n            $('<p><strong><em>'+currentBonusAction.name+'.</em></strong> '+currentBonusAction.text+'</p>').appendTo('#bonus-actions');\r\n        }\r\n    } else {\r\n        $('#bonus-actions-wrapper').hide();\r\n    }\r\n }\r\n\r\n/**\r\n * Converts challenge rating to a \"step\" so that fractional CRs carry the same weight in scaling as full number CRs.\r\n *\r\n * @param {string} cr The challenge rating to convert to a step.\r\n * @return {number} The relative step for the challenge rating.\r\n */\r\nfunction stepForCR(cr) {\r\n    //Fractional CRs are counted as a full step in calculations, ie going from CR 1/8 to 1/4 carries as much weight as going from CR 1 to 2.\r\n    let safeCR = parseFloat(cr);\r\n    switch(safeCR) {\r\n        case 0:\r\n            return 0;\r\n        case 0.125:\r\n            return 1;\r\n        case 0.25:\r\n            return 2;\r\n        case 0.5: \r\n            return 3;\r\n        default:\r\n            return safeCR+3;\r\n    }\r\n}\r\n\r\n/**\r\n * Converts challenge rating to a string so that decimal CRs become fractions\r\n *\r\n * @param {string} cr The challenge rating to convert to a string.\r\n * @return {string} The string version of the challenge rating\r\n */\r\nfunction stringForCR(cr) {\r\n    let safeCR = parseFloat(cr);\r\n    switch(safeCR) {\r\n        case 0.125:\r\n            return '1/8';\r\n        case 0.25:\r\n            return '1/4';\r\n        case 0.5: \r\n            return '1/2';\r\n        default:\r\n            return cr;\r\n    }\r\n}\r\n\r\n/**\r\n * Finds the closest statblocks above and below the target CR that have the target stat(s)\r\n *\r\n * @param {Array} stats The stats to search for\r\n * @param {string} targetCR The challenge rating to find benchmarks for\r\n * @param {Object} sourceStats The stat block for which to find stat benchmarks\r\n * @return {Object} Benchmarks for the selected stat at the nearest CRs above and below it that had values for that stat.\r\n */\r\nfunction findBenchmarksForStat(stats, targetCR, sourceStats) {\r\n    let numTargetCR = Number(targetCR); //CRs must be compared as ints or the equality checks sometimes return the wrong result\r\n    let statList = Array.isArray(stats) ? stats : [stats];\r\n    let benchmarks = null;\r\n    for (let cr in sourceStats) {\r\n        let numCR = Number(cr);\r\n        let statBlock = flattenObject(sourceStats[cr]);\r\n        let allStatsFound = true;\r\n        for (let i = 0; i < statList.length; i++) {\r\n            allStatsFound = allStatsFound && statBlock.hasOwnProperty(statList[i]);\r\n            if (!allStatsFound) {\r\n                break;\r\n            }\r\n        }\r\n        if (allStatsFound) {\r\n            if (!benchmarks) {\r\n                benchmarks = {};\r\n            }\r\n            if (numCR > numTargetCR) {\r\n                if (!benchmarks.upper || benchmarks.upper.cr > numCR) {\r\n                    benchmarks.upper = {\r\n                        cr: numCR,\r\n                    }\r\n                    for (let i = 0; i < statList.length; i++) {\r\n                        benchmarks.upper[statList[i]] = statBlock[statList[i]];\r\n                    }\r\n                }\r\n            } else {\r\n                if (!benchmarks.lower || benchmarks.lower.cr < numCR) {\r\n                    benchmarks.lower = {\r\n                        cr: numCR,\r\n                    }\r\n                    for (let i = 0; i < statList.length; i++) {\r\n                        benchmarks.lower[statList[i]] = statBlock[statList[i]];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return benchmarks;\r\n}\r\n\r\n/**\r\n * Finds the closest statblocks above and below the target CR that have the target stat\r\n *\r\n * @param {string} stat The stat to extrapolate\r\n * @param {string} targetCR The challenge rating to find benchmarks for\r\n * @param {Object} benchmarks The upper and/or lower benchmarks to extrapolate from\r\n * @param {boolean} linearExtrapolation If true the extrapolation will be an offset instead of a ratio.\r\n *  For example, a template with a value of 5 when the average stat is 4 would result in an offset of +1 instead of a multiplier of *1.2.\r\n * @return {Number} The extrapolated value\r\n */\r\nfunction extrapolateFromBenchmark(stat, targetCR, benchmarks, linearExtrapolation) {\r\n    //If a benchmark was only found in one direction we simply use that benchmark to extrapolate a state for the target CR\r\n    //If benchmarks were found above and below, we calculate the target result for BOTH benchmarks, then take a weighted average based on which is closer\r\n    //So if the upper benchmark is 1 step away, and the lower benchmark is 4 steps away, then the upper will count for 80% of the average\r\n    let upperValue, lowerValue;\r\n    if (benchmarks.upper) {\r\n        if (linearExtrapolation) {\r\n            let offset = benchmarks.upper[stat] - averageStats[benchmarks.upper.cr][stat];\r\n            upperValue = offset + averageStats[targetCR][stat];\r\n        } else {\r\n            let ratio = benchmarks.upper[stat] / averageStats[benchmarks.upper.cr][stat];\r\n            upperValue = ratio * averageStats[targetCR][stat];\r\n        }\r\n    }\r\n    if (benchmarks.lower) {\r\n        if (linearExtrapolation) {\r\n            let offset = benchmarks.lower[stat] - averageStats[benchmarks.lower.cr][stat];\r\n            lowerValue = offset + averageStats[targetCR][stat];\r\n        } else {\r\n            let ratio = benchmarks.lower[stat] / averageStats[benchmarks.lower.cr][stat];\r\n            lowerValue = ratio * averageStats[targetCR][stat];\r\n        }\r\n    }\r\n\r\n    if (lowerValue) {\r\n        if (upperValue) {\r\n            //If upper and lower take a weighted average\r\n            let upperStep = stepForCR(benchmarks.upper.cr);\r\n            let lowerStep = stepForCR(benchmarks.lower.cr);\r\n            let stepRange = upperStep - lowerStep;\r\n            let targetStep = stepForCR(targetCR);\r\n            let lowerWeight = (upperStep - targetStep) / stepRange;\r\n            let upperWeight = (targetStep - lowerStep) / stepRange;\r\n            return Math.round(upperWeight * upperValue + lowerWeight * lowerValue);\r\n        }\r\n        return Math.round(lowerValue);\r\n    }\r\n    return Math.round(upperValue);\r\n}\r\n\r\n/**\r\n * Generates a trait or proc description, calculating attributes such as damage and DC and then replacing tokens in the description string\r\n *\r\n * @param {string} traitName The id of the base trait (or proc) to use\r\n * @param {string} targetCR The challenge rating to generate the trait for\r\n * @param {Object} sourceStats The stat block to use for finding trait benchmarks\r\n * @return {Object} A new trait or proc with a completed description and scaled attributes (DC, Damage, etc)\r\n */\r\nfunction generateTrait(traitName, targetCR, sourceStats) {\r\n    let baseTrait = traits[traitName] || procs[traitName] || actions[traitName];\r\n    let newTrait = Object.assign({}, baseTrait);\r\n    if (sourceStats[targetCR] && sourceStats[targetCR].traits && sourceStats[targetCR].traits[traitName]) {\r\n        newTrait = Object.assign(newTrait, sourceStats[targetCR].traits[traitName]);\r\n    }\r\n\r\n    if (baseTrait.allowsSave) {\r\n        if (!newTrait.hasOwnProperty(\"dcAdjustment\")) {\r\n            let dcAdjustmentString = \"traits__\"+traitName+\"__dcAdjustment\";\r\n            let dcAdjustmentBenchmarks = findBenchmarksForStat(dcAdjustmentString, targetCR, sourceStats);\r\n            if (dcAdjustmentBenchmarks) {\r\n                if (dcAdjustmentBenchmarks.upper) {\r\n                    if (dcAdjustmentBenchmarks.lower) {\r\n                        newTrait.dcAdjustment = calculateWeightedAverage(dcAdjustmentString, dcAdjustmentBenchmarks, targetCR);\r\n                    } else {\r\n                        newTrait.dcAdjustment = dcAdjustmentBenchmarks.upper[dcAdjustmentString];\r\n                    }\r\n                } else if (dcAdjustmentBenchmarks.lower) {\r\n                    newTrait.dcAdjustment = dcAdjustmentBenchmarks.lower[dcAdjustmentString];\r\n                }\r\n            } else {\r\n                newTrait.dcAdjustment = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (baseTrait.hasDuration) {\r\n        if (!newTrait.hasOwnProperty(\"duration\")) {\r\n            let durationString = \"traits__\"+traitName+\"__duration\";\r\n            newTrait.duration = findNearestLowerBenchmark(durationString, targetCR, sourceStats);\r\n        }\r\n    }\r\n\r\n    if (baseTrait.sizeRestricted) {\r\n        if (!newTrait.hasOwnProperty(\"sizeAdjustment\")) {\r\n            let sizeAdjustmentString = \"traits__\"+traitName+\"__sizeAdjustment\";\r\n            newTrait.sizeAdjustment = findNearestLowerBenchmark(sizeAdjustmentString, targetCR, sourceStats);\r\n        }\r\n    }\r\n\r\n    if (baseTrait.appliesCondition) {\r\n        if (!newTrait.hasOwnProperty(\"condition\")) {\r\n            let conditionString = \"traits__\"+traitName+\"__condition\";\r\n            newTrait.condition = findNearestLowerBenchmark(conditionString, targetCR, sourceStats);\r\n        }\r\n    }\r\n\r\n    if (baseTrait.dealsDamage) {\r\n        let damageDiceString = 'traits__'+traitName+'__damageDice';\r\n        let damageDieSizeString =  'traits__'+traitName+'__damageDieSize';\r\n\r\n        let estimatedDice = scaleDamageRoll(damageDiceString, damageDieSizeString, targetCR, sourceStats);\r\n        newTrait.damageDice = estimatedDice[0];\r\n        newTrait.damageDieSize = estimatedDice[1];\r\n    }\r\n\r\n    return newTrait;\r\n}\r\n\r\n/**\r\n * Calculates the modifier for an ability score\r\n *\r\n * @param {string} ability The ability score value\r\n * @return {number} The ability score modifier\r\n */\r\nfunction abilityScoreModifier(ability) {\r\n    return Math.floor((ability - 10) / 2);\r\n}\r\n\r\n/**\r\n * Calculates the weighted average for a state between two CRs, ie if benchmarks are found for one CR below and 4 CR above, an average weighted toward the lower benchmark will be calculated\r\n *\r\n * @param {string} stat The name of the stat to average.\r\n * @param {Object} benchmarks The benchmarks to average from.\r\n * @return {number} The weighted average value\r\n */\r\nfunction calculateWeightedAverage(stat, benchmarks, targetCR) {\r\n    let upperStep = stepForCR(benchmarks.upper.cr);\r\n    let lowerStep = stepForCR(benchmarks.lower.cr);\r\n    let stepRange = upperStep - lowerStep;\r\n    let targetStep = stepForCR(targetCR);\r\n    let upperWeight = (upperStep - targetStep) / stepRange;\r\n    let lowerWeight = (targetStep - lowerStep) / stepRange;\r\n    return Math.round(upperWeight * benchmarks.upper[stat] + lowerWeight * benchmarks.lower[stat]);\r\n}\r\n\r\n/**\r\n * Calculates the hit dice per hit die for a creature\r\n *\r\n * @param {Object} statblock The statblock. Must have size and con\r\n * @return {number} The number of hit points\r\n */\r\nfunction hitPointsPerHitDie(statblock) {\r\n    return ((sizes[statblock.size].hitDie + 1) / 2) + abilityScoreModifier(statblock.con);\r\n}\r\n\r\n/**\r\n * Finds the closest benchmark that is below the target CR. If there are none then it returns the lowest benchmark.\r\n *\r\n * @param {string} stat The stat to search for\r\n * @param {string} targetCR The target challenge rating\r\n * @param {Object} statList The stat list to search \r\n * @return {number} The benchmark found\r\n */\r\nfunction findNearestLowerBenchmark(stat, targetCR, statList) {\r\n    let numTargetCR = parseFloat(targetCR);\r\n    let lowestValue;\r\n    let lowestCR = 31;\r\n    let highestValue;\r\n    let highestCR = 0;\r\n    for (let cr in statList) {\r\n        let numCR = parseFloat(cr);\r\n        let statBlock = flattenObject(statList[cr]);\r\n        if (statBlock[stat]) {\r\n            if (numCR < lowestCR) {\r\n                lowestCR = cr;\r\n                lowestValue = statBlock[stat];\r\n            }\r\n            if (numCR > highestCR && numCR <= numTargetCR) {\r\n                highestValue = statBlock[stat];\r\n                highestCR = cr;\r\n            }\r\n        }\r\n    }\r\n    return highestValue != null ? highestValue : lowestValue;\r\n}\r\n\r\n/**\r\n * Returns a sentence case version of a string\r\n *\r\n * @param {string} targetString The string to convert to sentence case\r\n * @return {string} The sentence case string\r\n */\r\nfunction toSentenceCase(targetString) {\r\n    return targetString.replace(/(^\\s*\\w|[\\.\\!\\?]\\s*\\w)/g,function(c){return c.toUpperCase()});\r\n}\r\n\r\n/**\r\n * Returns a title case version of a string\r\n *\r\n * @param {string} targetString The string to convert to title case\r\n * @return {string} The title case string\r\n */\r\nfunction toTitleCase(targetString) {\r\n    var sentence = targetString.toLowerCase().split(\" \");\r\n    for(var i = 0; i< sentence.length; i++){\r\n       sentence[i] = sentence[i][0].toUpperCase() + sentence[i].slice(1);\r\n    }\r\n    return sentence.join(\" \");\r\n}\r\n\r\n /**\r\n * Replaced various tokens in a string with appropriate values\r\n *\r\n * @param {string} targetString The string in which to find and replace tokens\r\n * @param {Object} statBlock The statblock to use when replacing stat related tokens, such as save DCs\r\n * @param {Object} trait Secondary stat block for a specific trait, which is used when determing trait related tokens\r\n * @return {string} The result string with tokens replaced\r\n */\r\n function replaceTokensInString(targetString, statBlock, trait) {\r\n    let outputString = targetString;\r\n    while (outputString.indexOf('{{') >= 0) {\r\n        let tokenStartIndex = outputString.indexOf('{{');\r\n        let tokenEndIndex = outputString.indexOf('}}')+2;\r\n        let fullToken = outputString.substr(tokenStartIndex,tokenEndIndex-tokenStartIndex);\r\n        let token = fullToken.substr(2, fullToken.length-4);\r\n        let tokenValue = '';\r\n\r\n        if (statBlock[token]) {\r\n            tokenValue = statBlock[token];\r\n        } else if (token === \"castingStatName\") {\r\n            let statNames = {\r\n                int: \"Intelligence\",\r\n                wis: \"Wisdom\",\r\n                cha: \"Charisma\"\r\n            }\r\n            tokenValue = statNames[statBlock.castingStat];\r\n        } else if (token === \"castingModifier\") {\r\n            tokenValue = '+' + statBlock.abilityModifiers[statBlock.castingStat];\r\n        } else if (token === \"spellSaveDC\") {\r\n            tokenValue = 8 + statBlock.proficiency + statBlock.abilityModifiers[statBlock.castingStat];\r\n        } else {\r\n            let tokenArray = token.split(':');\r\n            if (tokenArray[0] == 'DC') {\r\n                let dc =  8 + statBlock.proficiency + statBlock.abilityModifiers[tokenArray[1]];\r\n                if (tokenArray.length > 2) {\r\n                    dc += parseInt(tokenArray[2]);\r\n                }\r\n                tokenValue = dc;\r\n            } else if (tokenArray[0] == 'size') {\r\n                let targetSize = statBlock.size + parseInt(tokenArray[1]);\r\n                tokenValue = sizes[targetSize].name;\r\n            } else if (tokenArray[0] == 'trait') {\r\n                if (trait[tokenArray[1]]) {\r\n                    tokenValue = trait[tokenArray[1]];\r\n                } else if (tokenArray[1] == 'DC') {\r\n                    let dc =  8 + statBlock.proficiency + statBlock.abilityModifiers[trait.dcStat];\r\n                    if (trait.dcAdjustment) {\r\n                        dc += parseInt(trait.dcAdjustment);\r\n                    }\r\n                    tokenValue = dc;\r\n                } else if (tokenArray[1] === 'size') {\r\n                    let targetSize = statBlock.size;\r\n                    if (trait.sizeAdjustment) {\r\n                        targetSize += trait.sizeAdjustment;\r\n                    }\r\n                    tokenValue = sizes[targetSize].name;\r\n                } else if (tokenArray[1] === 'damage') {\r\n                    let damageDice = trait.damageDice;\r\n                    let damageDieSize = trait.damageDieSize;\r\n                    if (damageDieSize === 1) {\r\n                        tokenValue = damageDice;\r\n                    } else {\r\n                        tokenValue = damageString(damageDice, damageDieSize);\r\n                    }\r\n                } else if (tokenArray[1] === \"castingClass\") {\r\n                    //Because spellcasters can have two casting classes we convert the array to a string, then replace the comma\r\n                    tokenValue = ('' + statBlock.castingClass).replace(',',' and ');\r\n                } else if (tokenArray[1] === \"ordinalLevel\") {\r\n                    //Default to character level if trait doesn't have level set\r\n                    let level = trait.level || statBlock.level;\r\n                    tokenValue = getOrdinal(level);\r\n                } else if (tokenArray[1] === 'spellListInnate') {\r\n                    let spellList = [];\r\n                    for (let spellId in trait.spellList) {\r\n                        let spell = trait.spellList[spellId];\r\n                        let uses = spell.uses;\r\n                        if (spellList[uses]) {\r\n                            spellList[uses].push(spellId);\r\n                        } else {\r\n                            spellList[uses] = [spellId];\r\n                        }\r\n                    }\r\n\r\n                    function formatSpellNames(spellArray) {\r\n                        let output = '';\r\n                        for (let i = 0; i < spellArray.length; i++) {\r\n                            if (output.length) {\r\n                                output += ', ';\r\n                            }\r\n                            output += spells[spellArray[i]].name;\r\n                        }\r\n                        return output;\r\n                    }\r\n\r\n                    tokenValue = \"<span class='trait-spacer'></span>\";\r\n                    if (spellList[0]) {\r\n                        tokenValue += \"At will: \" + formatSpellNames(spellList[0]);\r\n                        tokenValue += \"<br/>\";\r\n                    }\r\n                    for (let i = spellList.length - 1; i > 0; i--) {\r\n                        if (spellList[i]) {\r\n                            tokenValue += i + '/day' + (spellList[i].length > 1 ? ' each' : '') + ': ' + formatSpellNames(spellList[i]); \r\n                            tokenValue += \"<br/>\";\r\n                        }\r\n                    }\r\n                }\r\n            } else if (tokenArray[0] == 'pronoun') {\r\n                tokenValue = pronouns[statBlock.gender][tokenArray[1]];\r\n            }\r\n        }\r\n\r\n        outputString = outputString.replace(fullToken, tokenValue);\r\n    } \r\n    return toSentenceCase(outputString);\r\n }\r\n\r\n /**\r\n * Recursively flattens an object. ie, {x: {y:5}, z: 10} would become {x__y : 5, z : 10}\r\n *\r\n * @param {Object} targetObject The object to flatten\r\n * @return {Object} The flattened object\r\n */\r\n function flattenObject(targetObject) {\r\n    let outputObject = {};\r\n    for (let property in targetObject) {\r\n        let value = targetObject[property];\r\n        if (typeof(value) == 'object') {\r\n            let flattenedChild = flattenObject(value);\r\n            for (let childProperty in flattenedChild) {\r\n                outputObject[property+'__'+childProperty] = flattenedChild[childProperty];\r\n            }\r\n        } else {\r\n            outputObject[property] = value;\r\n        }\r\n    }\r\n    return outputObject;\r\n}\r\n\r\n /**\r\n * Returns the average roll for a number of dice\r\n *\r\n * @param {Number} diceCount The number of dice to roll\r\n * @param {Number} dieSize The size of the dice being rolled\r\n * @return {Number} The average roll, rounded down\r\n */\r\nfunction averageRoll(diceCount, dieSize) {\r\n    let averagePerDie = (1 + dieSize) / 2;\r\n    return Math.floor(diceCount * averagePerDie);\r\n}\r\n\r\n/**\r\n * Returns a damage string based on a set of damage dice and a modifier.\r\n * Eg 1, 4, 1, becomes 3 (1d4 + 1)\r\n *\r\n * @param {Number} damageDice The number of damage dice\r\n * @param {Number} damageDieSize The size of the damage dice\r\n * @param {Number} [damageBonus=0] The damage modifier (from ability scores, enchantments, etc)\r\n * @return {string} The damage string\r\n */\r\nfunction damageString(damageDice, damageDieSize, damageBonus = 0) {\r\n    let maxDamage = damageDice * damageDieSize + damageBonus;\r\n    //If the attack can't do more than one damage total omit the roll and just show 1 flat damage\r\n    if (maxDamage > 1) {\r\n        if (damageDieSize == 1) {\r\n            return damageDice + damageBonus;\r\n        }\r\n        let output = averageRoll(damageDice, damageDieSize) + damageBonus + ' (' + damageDice + 'd' + damageDieSize;\r\n        if (damageBonus) {\r\n            output += (damageBonus >= 0 ? ' + ' : ' - ' ) + Math.abs(damageBonus);\r\n        }\r\n        output += ')';\r\n        return output;\r\n    } \r\n    return '1';\r\n}\r\n\r\n/**\r\n * Returns an appropriate damage die size and count to reach an estiamted average damage number\r\n *\r\n * @param {Number} targetDamage The target average damage\r\n * @param {Number} preferredDieSize The preferred die size to return, usually the monster's original damage die. This will be used unless the target number so low a single die is too much, or so high that this would result in an excessive number of dice\r\n * @return {Array} An array containing number of dice at index 0 and die size at index 1\r\n */\r\nfunction findDamageDice(targetDamage, preferredDieSize) {\r\n    //If target damage is too low for a d4 return 1d1\r\n    if (targetDamage < 1.25) {\r\n        return [1,1];\r\n    }\r\n    //For creatures that have a fixed 1d1 at CR 0 use d4 as their preferred die\r\n    preferredDieSize = Math.max(preferredDieSize,4);\r\n\r\n    //TODO: Consider capping damage dice for specific attacks and split high damage attacks into multiattacks\r\n    //This method tries to find the damage die that would yield the best average damage, but favors larger dice so mosnters don't all end up using loads of d4s.\r\n    let maximumDice = 15; //If the number of dice exceeds this the next step up will be used, unless the die size is already d12.\r\n    let dice = [12, 10, 8, 6, 4];\r\n    let dieAverages = [6.5, 5.5, 4.5, 3.5, 2.5];\r\n    //If the preferred die is a larger one make sure that a single die is not too much.\r\n    //For example, if a creature with d12 attacks is scaled down to CR 0 even 1d12 may be too much average damage\r\n    if (targetDamage < dieAverages[dice.indexOf(preferredDieSize)] - .5) {\r\n        //If target damage is closer to a lower average then the preferred die size is too high\r\n        let desiredAverage = Math.floor(targetDamage) + .5; //Round and add .5 to make it match a die average\r\n        desiredAverage = Math.max(desiredAverage, 2.5); //Make sure it's at least the average for a d4 in case it's a very low number\r\n        return [1, dice[dieAverages.indexOf(desiredAverage)]];        \r\n\r\n    }\r\n\r\n    let dieCount = Math.round(targetDamage/dieAverages[dice.indexOf(preferredDieSize)]);\r\n    let dieSize = preferredDieSize;\r\n    while (dieCount > maximumDice && dieSize < 12) {\r\n        dieSize = dice[dice.indexOf(dieSize)-1];\r\n        dieCount = Math.round(targetDamage/dieAverages[dice.indexOf(dieSize)]);\r\n    }\r\n    return [dieCount, dieSize];\r\n}\r\n\r\n/**\r\n * Merges two arrays, creating a new array with the combined values excepting any duplicates\r\n *\r\n * @param {Array} array1 The first array to merge\r\n * @param {Array} array2 The second array to merge\r\n * @return {Array} An array containing the combined values of arrays 1 and 2 without any duplicates\r\n */\r\nfunction mergeArrays(array1, array2) {\r\n    let output = array1.slice();\r\n    for (let i = 0; i < array2.length; i++) {\r\n        if (!output.includes(array2[i])) {\r\n            output.push(array2[i]);\r\n        }\r\n    }\r\n    return output;\r\n}\r\n\r\n/**\r\n * Recursively merges two objects. This differs from object assign in that it recursively merges child objects of the two params.\r\n * \r\n * The output object will have all fields from both input objects. If both input objects contain a value for a given key the following will occur based on the value's type:\r\n * Array: The two arrays will be merged using the mergeArrays function.\r\n * Object: This function will be recursively called on the child objects.\r\n * All other types: The value of object2 will be used (as with Object.assign)\r\n *\r\n * @param {Object} object1 The first object to merge\r\n * @param {Object} object2 The second object to merge\r\n * @return {Object} Object containing the merged values of the two input objects\r\n */\r\n function mergeObjects(object1, object2) {\r\n    let output = Object.assign({}, object1);\r\n    for (const [key, value] of Object.entries(object2)) {\r\n        if (Array.isArray(value)) {\r\n            if (output.hasOwnProperty(key)) {\r\n                //Merge if both object have a value\r\n                output[key] = mergeArrays(output[key], value);\r\n            } else {\r\n                //If only the second input has it then copy it\r\n                output[key] = value.slice();\r\n            }\r\n        } else if (typeof(value) == 'object') {\r\n            if (output.hasOwnProperty(key)) {\r\n                //Merge if both object have a value\r\n                output[key] = mergeObjects(output[key], value);\r\n            } else {\r\n                //If only the second input has it then copy it\r\n                output[key] = Object.assign({}, value);\r\n            }\r\n        } else {\r\n            output[key] = value;\r\n        }\r\n\r\n    }\r\n    return output;\r\n}\r\n\r\n/**\r\n * Converts a creature's statistic into the XML format used by Fight Club 5e and initiates a download\r\n * TODO: Values pulled from the statblock div should be saved to the statblock object and pulled from there instead\r\n * @param {Object} statblock The statblock to convert to XML\r\n */\r\nfunction exportFightClub(statblock) {\r\n    //TODO: Gotta fix this for pages without CR\r\n    let cr = $('#target-cr').val();\r\n    let fightClubXML = xmlNode('name', $('#monster-name').html());\r\n    fightClubXML += xmlNode('size', sizes[statblock.size].name.substring(0,1));\r\n    fightClubXML += xmlNode('type', statblock.type);\r\n    fightClubXML += xmlNode('alignment', statblock.alignment);\r\n    fightClubXML += xmlNode('ac', $('#armor-class span').html());\r\n    fightClubXML += xmlNode('hp', $('#hit-points span').html());\r\n    fightClubXML += xmlNode('speed', $('#speed span').html());\r\n    fightClubXML += xmlNode('str', statblock.str);\r\n    fightClubXML += xmlNode('dex', statblock.dex);\r\n    fightClubXML += xmlNode('con', statblock.con);\r\n    fightClubXML += xmlNode('int', statblock.int);\r\n    fightClubXML += xmlNode('wis', statblock.wis);\r\n    fightClubXML += xmlNode('cha', statblock.cha);\r\n    //TODO: Saves\r\n    fightClubXML += xmlNode('save', '');\r\n    fightClubXML += xmlNode('skill', $('#skills span').html());\r\n    fightClubXML += xmlNode('passive', statblock.passivePerception);\r\n    fightClubXML += xmlNode('languages', $('#languages span').html());\r\n    fightClubXML += xmlNode('cr', cr);\r\n    fightClubXML += xmlNode('resist', $('#resistances span').html().toLowerCase());\r\n    fightClubXML += xmlNode('immune', $('#immunities span').html().toLowerCase());\r\n    fightClubXML += xmlNode('vulnerable', $('#vulnerabilities span').html().toLowerCase());\r\n    fightClubXML += xmlNode('conditionImmune', $('#condition-immunities span').html().toLowerCase());\r\n    fightClubXML += xmlNode('senses', statblock.sensesString);\r\n    for (let traitName in statblock.traits) {\r\n        let traitXML = xmlNode('name', statblock.traits[traitName].name);\r\n        traitXML += xmlNode('text', statblock.traits[traitName].text);\r\n        fightClubXML += xmlNode('trait', traitXML);\r\n    }\r\n    if (statblock.multiattack) {\r\n        let multiattackXML = xmlNode('name', \"Multiattack\");\r\n        multiattackXML += xmlNode('text', statblock.multiattackString);\r\n        fightClubXML += xmlNode('action', multiattackXML);\r\n    }\r\n    for (let attackName in statblock.attacks) {\r\n        let currentAttack = statblock.attacks[attackName];\r\n        let attackXML = xmlNode('name', currentAttack.name);\r\n        attackXML += xmlNode('text', currentAttack.text.replace(/<\\/?em>/g, '')); //Strip out <em> tags\r\n\r\n        let attackString = currentAttack.name + '|';\r\n        attackString += (currentAttack.attackBonus >= 0 ? '+' : '-' ) + Math.abs(currentAttack.attackBonus) + '|';\r\n        attackString += currentAttack.damageDice + 'd' + currentAttack.damageDieSize;\r\n        if (currentAttack.damageBonus) {\r\n            attackString += (currentAttack.damageBonus >= 0 ? '+' : '-' ) + Math.abs(currentAttack.damageBonus);\r\n        }\r\n\r\n        attackXML += xmlNode('attack', attackString);\r\n        fightClubXML += xmlNode('action', attackXML);\r\n    }\r\n    for (let bonusActionName in statblock.bonusActions) {\r\n        //Fight club XML doesn't appear to supprot bonus actions, so for now we just export them as actions and add a note.\r\n        let bonusActionXML = xmlNode('name', statblock.bonusActions[bonusActionName].name + ' (Bonus Action)');\r\n        bonusActionXML += xmlNode('text', statblock.bonusActions[bonusActionName].text);\r\n        fightClubXML += xmlNode('action', bonusActionXML);\r\n    }\r\n    //TODO: Bonus Actions\r\n    fightClubXML = xmlNode('monster', fightClubXML);\r\n    fightClubXML = \"<?xml version='1.0' encoding='utf-8'?>\" + xmlNode(\"compendium\", fightClubXML);\r\n\r\n    var filename = statblock.slug+'-cr-'+cr+'.xml';\r\n    var pom = document.createElement('a');\r\n    var bb = new Blob([fightClubXML], {type: 'text/plain'});\r\n\r\n    pom.setAttribute('href', window.URL.createObjectURL(bb));\r\n    pom.setAttribute('download', filename);\r\n\r\n    pom.dataset.downloadurl = ['text/plain', pom.download, pom.href].join(':');\r\n    pom.draggable = true; \r\n    pom.classList.add('dragout');\r\n\r\n    pom.click();\r\n}\r\n\r\n/**\r\n * Converts a creature's statistic into JSON and initiates a download\r\n * @param {Object} statblock The statblock to convert to JSON\r\n */\r\nfunction exportJSON(statblock) {\r\n    //TODO: Gotta fix this for pages without CR\r\n    let cr = $('#target-cr').val();\r\n    let jsonOutput = JSON.stringify(statblock);\r\n\r\n    var filename = statblock.slug+'-cr-'+cr+'.json';\r\n    var pom = document.createElement('a');\r\n    var bb = new Blob([jsonOutput], {type: 'text/plain'});\r\n\r\n    pom.setAttribute('href', window.URL.createObjectURL(bb));\r\n    pom.setAttribute('download', filename);\r\n\r\n    pom.dataset.downloadurl = ['text/plain', pom.download, pom.href].join(':');\r\n    pom.draggable = true; \r\n    pom.classList.add('dragout');\r\n\r\n    pom.click();\r\n}\r\n\r\n\r\n/**\r\n * Simple helper function to return an XML node based on a tag and value. Shortcut to save having to type tags twice.\r\n * \r\n * @param {string} tag The xml tag, eg \"name\"\r\n * @param {string} value The value to wrap within the tag, eg \"Dire Wolf\"\r\n * @return {string} The XML node, eg \"<name>Dire Wolf</name>\"\r\n */\r\n function xmlNode(tag, value) {\r\n    return \"<\"+tag+\">\"+value+\"</\"+tag+\">\";\r\n }\r\n\r\n /**\r\n * Takes a damage (or healing) roll and scales it based on average damage by CR\r\n * TODO: Add ability score modifiers and use this function for basic attacks as well\r\n *\r\n * @param {string} damageDiceString Flattened path to the damage dice attribute, eg attacks__bite__damageDice\r\n * @param {string} damageDieString Flattened path to the damage die size attribute, eg attacks__bite__damageDieSize\r\n * @param {string} targetCR The challenge rating to generate the damage for\r\n * @param {Object} sourceStats The stat block to use for finding damage benchmarks\r\n * @return {Array} An array containing number of dice at index 0 and die size at index 1\r\n */\r\n function scaleDamageRoll(damageDiceString, damageDieSizeString, targetCR, sourceStats) {\r\n\r\n    let attributes = [damageDiceString, damageDieSizeString];\r\n\r\n    let damageBenchmarks = findBenchmarksForStat(attributes, targetCR, sourceStats);\r\n    for (let benchmark in damageBenchmarks) {\r\n        let currentBenchmark = damageBenchmarks[benchmark];\r\n        currentBenchmark.damagePerRound = averageRoll(currentBenchmark[damageDiceString], currentBenchmark[damageDieSizeString]);\r\n    }\r\n\r\n    let estimatedDamage = extrapolateFromBenchmark('damagePerRound', targetCR, damageBenchmarks, false);\r\n    let preferredDieSize = findNearestLowerBenchmark(damageDieSizeString, targetCR, sourceStats);\r\n    \r\n    let estimatedDice = findDamageDice(estimatedDamage, preferredDieSize);\r\n    return estimatedDice;\r\n}\r\n\r\n/**\r\n * Serializes a form by turning all of its inputs into a query string. \r\n * This custom method is used in place of the native JQuery one to avoid including hidden inputs.\r\n * \r\n * @param {Object} $form The form to serialize\r\n * @return {string} The serialized query string\r\n */\r\nfunction serializeForm($form) {\r\n    let output = '';\r\n    $form.find('select:visible').each(function () {\r\n        let value = $(this).val();\r\n        //Some selects default to 0 so we can comfortably skip it\r\n        if (value && value.length && value !== '0') {\r\n            output += '&' + $(this).attr('id') + '=' + value;\r\n        }\r\n    });\r\n\r\n    $form.find('input:visible:not([type=\"checkbox\"])').each(function () {\r\n        let value = $(this).val();\r\n        if (value) {\r\n            output += '&' + $(this).attr('id') + '=' + value;\r\n        }\r\n    });\r\n\r\n    //No need for a value for checkboxes, just including the id if they are checked is enough\r\n    $form.find('input:visible:checked').each(function () {\r\n        output += '&' + $(this).attr('id');\r\n    });\r\n\r\n    //Trim the first &\r\n    output = output.replace('&', '');\r\n\r\n    return output;\r\n}\r\n\r\n/**\r\n * Attempts to parse the current search/query parameters to populate form inputs.\r\n * Page specific scripts can call this once all data driven fields are generated/populated.\r\n * \r\n */\r\nfunction deserializeQuery() {\r\n    if (location.search.length) {\r\n        let params = new URLSearchParams(location.search);\r\n\r\n        //Skip variant at first because it must come after monster\r\n        $('select').each(function () {\r\n            let value = params.get($(this).attr('id'));\r\n            if (value) {\r\n                if ($(this).attr('multiple')) {\r\n                    //Convert value to an array\r\n                    $(this).val(value.split(','));\r\n                    if ($(this).is('[data-limit')) {\r\n                        $(this).data('old-val', $(this).val());\r\n                    }\r\n                } else {\r\n                    //Make sure the value is valid\r\n                    if ($(this).children('option[value=\"'+value+'\"]').length) {\r\n                        $(this).val(value);\r\n                    }\r\n                }\r\n            }\r\n\r\n            //Trigger the change event if it has one, to populate any dependent selects\r\n            if ($(this).data('on-change')) {\r\n                window[$(this).data('on-change')](false);\r\n            }\r\n        });\r\n\r\n        $('input:not([type=\"checkbox\"])').each(function () {\r\n            let value = params.get($(this).attr('id'));\r\n            if (value) {\r\n                $(this).val(value);\r\n            }\r\n\r\n            //Trigger the change event if it has one, to populate any dependent selects\r\n            if ($(this).data('on-change')) {\r\n                window[$(this).data('on-change')](false);\r\n            }\r\n        });\r\n\r\n        $('input[type=\"checkbox\"]').each(function () {\r\n            if(params.get($(this).attr('id')) !== null) {\r\n                $(this)[0].checked = true;\r\n            }\r\n        });\r\n\r\n\r\n    } else {\r\n        //If there's no search string then fire all the change events to make sure everything gets into the right state\r\n        $('[data-on-change]').each(function () {\r\n            window[$(this).data('on-change')](false);\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Populates a select with entries from an object or array.\r\n * \r\n * @param {object|array} dataSource The source object or array\r\n * @param {string} selector The query selector for the select to populate\r\n */\r\nfunction populateSelect(dataSource, selector) {\r\n    if (Array.isArray(dataSource)) {\r\n        for (let i = 0; i < dataSource.length; i ++) {\r\n            $('<option>'+dataSource[i]+'</option>').appendTo(selector);\r\n        }\r\n    } else {\r\n        for (let key in dataSource) {\r\n            $('<option value='+key+'>'+(dataSource[key].name || toSentenceCase(key))+'</option>').appendTo(selector);\r\n        }\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * Finds the ordinal for a given number\r\n * \r\n * @param {number} n The number to convert to an ordinal\r\n * @return {string} The ordinal for the parameter.\r\n */\r\nfunction getOrdinal(n) {\r\n    if (n % 10 == 1 && n % 100 != 11) {\r\n      return n + 'st';\r\n    }\r\n    if (n % 10 == 2 && n % 100 != 12) {\r\n      return n + 'nd';\r\n    }\r\n    if (n % 10 == 3 && n % 100 != 13) {\r\n      return n + 'rd';\r\n    }\r\n  \r\n    return n + 'th';\r\n  }\r\n  "],"names":["numberStrings","$","on","window","data","val","length","setupVariantSelect","animated","animationDuration","monsterID","selectedMonster","monsterList","variants","empty","variant","name","appendTo","fadeIn","fadeOut","type","typeHumanoid","race","raceAny","scaleMonster","targetCR","options","numTargetCR","Number","selectedVariant","sourceStats","Object","assign","stats","cr","mergeObjects","derivedStats","gender","lockedStats","currentRace","races","extraLanguages","languages","Math","max","subtype","hide","proficiency","averageStats","alignment","findNearestLowerBenchmark","slug","appearance","description","unique","lockedTraits","traits","traitList","concat","i","generateTrait","actions","bonusActions","size","sizeBenchmarks","findBenchmarksForStat","extrapolateFromBenchmark","min","abilityModifiers","ability","abilities","abilityBenchmarks","abilityScoreModifier","bonusArmor","undefined","acBenchmarks","benchmark","ac","dex","targetAC","hitDice","hpStats","push","hpBenchmarks","currentBenchmark","hp","floor","hitPointsPerHitDie","targetHP","hpPerHD","round","parseFloat","attacks","attack","attackCopy","damageDice","damageDieSize","currentAttack","damageDiceString","damageDieString","attributes","finesse","damageBenchmarks","damagePerRound","averageRoll","str","estimatedDamage","targetDamage","preferredDieSize","estimatedDice","findDamageDice","ranged","range","longRange","damageRiderType","damageRiderDice","damageDieSizeString","scaleDamageRoll","damageRiderDieSize","proc","generatedProc","multiattack","numCR","highestCR","stat","bonusStats","speed","swim","climb","burrow","fly","senses","sense","renderStatblock","availableSpells","traitName","trait","spellList","spell","html","wildShape","defaultName","sizes","armorDescription","acTotal","armor","armorTypes","toSentenceCase","armorTypeLight","armorTypeMedium","armorString","includes","bonusHP","con","damageString","hitDie","speedString","modifier","modifierString","saves","show","saveString","save","saveModifier","skills","skillString","skill","skillModifier","vulnerabilities","vulnerabilitiesString","resistances","resistancesString","immunities","immunitiesString","conditionImmunities","conditionImmunitiesString","sensesString","passivePerception","wis","hasOwnProperty","stringForCR","xp","toLocaleString","currentTrait","text","replaceTokensInString","languagesString","multiattackString","keys","attackCount","toLowerCase","requireDifferentTargets","abilityModifier","spellAttack","castingStat","shillelagh","attackBonus","damageBonus","parseInt","enhancement","attackString","rangeString","reach","proneOnly","creatureOnly","notGrappled","maxDamage","abs","damageType","wsRiderDice","actionName","currentAction","bonusActionName","currentBonusAction","stepForCR","safeCR","statList","Array","isArray","benchmarks","statBlock","flattenObject","allStatsFound","upper","lower","linearExtrapolation","upperValue","lowerValue","offset","ratio","upperStep","lowerStep","stepRange","targetStep","lowerWeight","upperWeight","baseTrait","procs","newTrait","allowsSave","dcAdjustmentString","dcAdjustmentBenchmarks","dcAdjustment","calculateWeightedAverage","hasDuration","durationString","duration","sizeRestricted","sizeAdjustmentString","sizeAdjustment","appliesCondition","conditionString","condition","dealsDamage","statblock","lowestValue","lowestCR","highestValue","targetString","replace","c","toUpperCase","toTitleCase","sentence","split","slice","join","outputString","indexOf","tokenStartIndex","tokenEndIndex","fullToken","substr","token","tokenValue","statNames","int","cha","tokenArray","dc","targetSize","dcStat","castingClass","level","getOrdinal","spellId","uses","formatSpellNames","spellArray","output","spells","pronouns","targetObject","outputObject","property","value","flattenedChild","childProperty","diceCount","dieSize","averagePerDie","maximumDice","dice","dieAverages","desiredAverage","dieCount","mergeArrays","array1","array2","object1","object2","key","entries","exportFightClub","fightClubXML","xmlNode","substring","traitXML","multiattackXML","attackName","attackXML","bonusActionXML","filename","pom","document","createElement","bb","Blob","setAttribute","URL","createObjectURL","dataset","downloadurl","download","href","draggable","classList","add","click","exportJSON","jsonOutput","JSON","stringify","tag","serializeForm","$form","find","each","attr","deserializeQuery","location","search","params","URLSearchParams","get","is","children","checked","populateSelect","dataSource","selector","n"],"mappings":"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"}