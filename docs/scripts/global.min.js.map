{"version":3,"file":"global.min.js","sources":["src/scripts/global.js"],"sourcesContent":["var numberStrings = ['zero', 'one', 'two', 'three', 'four', 'five'];\r\n\r\n$(function () {\r\n\r\n    for (let monster in monsterList) {\r\n        $('<option value='+monster+'>'+toSentenceCase(monster)+'</option>').appendTo('#monster-select');\r\n    }\r\n\r\n    if (location.search.length) {\r\n        let params = new URLSearchParams(location.search);\r\n        let paramMonster = params.get('monster');\r\n        let paramsCR = params.get('cr');\r\n        //Ensure it's a valid monster before selecting\r\n        if ($('#monster-select option[value=\"'+paramMonster+'\"]').length) {\r\n            $('#monster-select').val(paramMonster);\r\n        }\r\n         //Ensure it's a valid cr before selecting\r\n         if ($('#cr-select option[value=\"'+paramsCR+'\"]').length) {\r\n            $('#cr-select').val(paramsCR);\r\n        }\r\n    }\r\n\r\n    $('#monster-select, #cr-select').on('change', function () {\r\n        calculateSelectedMonster();\r\n    });\r\n\r\n    calculateSelectedMonster();\r\n\r\n});\r\n\r\n/**\r\n * Scales mosnter stats based on the selected template and challenge rating.\r\n */\r\nfunction calculateSelectedMonster() {\r\n    let monsterID = $('#monster-select').val();\r\n    let selectedMonster = monsterList[monsterID];\r\n    let targetCR = $('#cr-select').val();\r\n\r\n    let directLink = location.toString().replace(location.search, \"\");\r\n    directLink += '?monster='+monsterID+'&cr='+targetCR;\r\n    $('#direct-link').attr('href', directLink);\r\n\r\n    //Start with locked stats and presets for this CR, if any\r\n    let derivedStats = Object.assign({}, selectedMonster.lockedStats, selectedMonster.stats[targetCR]);\r\n    derivedStats.proficiency = averageStats[targetCR].proficiency;\r\n    //Once we have our locked stats, go through the rest of the states to interpolate or extrapolate based on existing values.\r\n    //All of the preset monster statblocks should be complete, but if we ever add \"keyframes\" for individual stats it may be possible to have CRs without all stats for a template\r\n    //For this reason we do the interpolation for EACH stat individually, rather than finding the closest statblock to draw from\r\n\r\n    if(!derivedStats.slug) {\r\n        derivedStats.slug = findNearestLowerBenchmark(\"slug\", targetCR, selectedMonster);\r\n    }\r\n\r\n    //Traits require a different approach from some other stats as we take a base from the trait library, but potentially apply modifiers to it based on creature stats.\r\n    //TODO: Adjust for creatures that gain additional traits as they level up\r\n    if (selectedMonster.traits) {\r\n        derivedStats.traits = {};\r\n        for (let i = 0; i < selectedMonster.traits.length; i++) {\r\n            const traitName = selectedMonster.traits[i];\r\n            const baseTrait = traits[traitName];\r\n            let newTrait;\r\n            derivedStats.traits[traitName] = newTrait = {};\r\n            newTrait.name = baseTrait.name;\r\n            newTrait.description = baseTrait.description;\r\n            if (selectedMonster.stats[targetCR] && selectedMonster.stats[targetCR].traits && selectedMonster.stats[targetCR].traits[traitName]) {\r\n                newTrait = Object.assign(newTrait, selectedMonster.stats[targetCR].traits[traitName]);\r\n            }\r\n\r\n            if (baseTrait.allowsSave) {\r\n                newTrait.dcStat = baseTrait.dcStat;\r\n                if (!newTrait.hasOwnProperty(\"dcAdjustment\")) {\r\n                    let dcAdjustmentString = \"traits__\"+traitName+\"__dcAdjustment\";\r\n                    let dcAdjustmentBenchmarks = findBenchmarksForStat(dcAdjustmentString, targetCR, selectedMonster);\r\n                    if (dcAdjustmentBenchmarks.upper) {\r\n                        if (dcAdjustmentBenchmarks.lower) {\r\n                            newTrait.dcAdjustment = calculateWeightedAverage(dcAdjustmentString, dcAdjustmentBenchmarks, targetCR);\r\n                        } else {\r\n                            newTrait.dcAdjustment = dcAdjustmentBenchmarks.upper[dcAdjustmentString];\r\n                        }\r\n                    } else if (dcAdjustmentBenchmarks.lower) {\r\n                        newTrait.dcAdjustment = dcAdjustmentBenchmarks.lower[dcAdjustmentString];\r\n                    } else {\r\n                        newTrait.dcAdjustment = 0;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if(!derivedStats.size) {\r\n        let sizeBenchmarks = findBenchmarksForStat(\"size\", targetCR, selectedMonster);\r\n        derivedStats.size = extrapolateFromBenchmark(\"size\", targetCR, sizeBenchmarks, true);\r\n        derivedStats.size = Math.min(6, derivedStats.size);\r\n    }\r\n\r\n    let abilityScores = [\"str\", \"con\", \"dex\", \"int\", \"wis\", \"cha\"];\r\n    derivedStats.abilityModifiers = {};\r\n    for (let i = 0; i < abilityScores.length; i++) {\r\n        if (!derivedStats[abilityScores[i]]) {\r\n            let abilityBenchmarks = findBenchmarksForStat(abilityScores[i], targetCR, selectedMonster);\r\n            derivedStats[abilityScores[i]] = extrapolateFromBenchmark(abilityScores[i], targetCR, abilityBenchmarks, false);\r\n        }\r\n        derivedStats.abilityModifiers[abilityScores[i]] = abilityScoreModifier(derivedStats[abilityScores[i]]);\r\n    }\r\n\r\n    if (!derivedStats.bonusArmor) {\r\n        /* \r\n         * CR is more concerned with derived stats like total AC than source stats like armor bonus\r\n         * So instead of extrapolating the armor bonus on its own we extrapolate total AC then reverse engineer armor bonus based on other AC mods\r\n         * This also solves the problem of average natural armor by CR being hard to calculate, since many creatures don't have natural armor.\r\n         */\r\n        let acBenchmarks = findBenchmarksForStat([\"bonusArmor\", \"dex\"], targetCR, selectedMonster);\r\n        //Creature may not have bonus armor at all, in which case we skip this step\r\n        if (acBenchmarks) {\r\n            for (let benchmark in acBenchmarks) {\r\n                //5e is sometimes vague about monster stat calculations, so for simplicity we assume all bonus armor allows the full dex modifier\r\n                acBenchmarks[benchmark].ac = 10 + acBenchmarks[benchmark].bonusArmor + abilityScoreModifier(acBenchmarks[benchmark].dex);\r\n            }\r\n            let targetAC = extrapolateFromBenchmark('ac', targetCR, acBenchmarks, false);\r\n            //The max check shouldn't really be necessary, but we don't want to risk a creature with abnormally high dex resulting in a negative bonus armor rating\r\n            derivedStats.bonusArmor = Math.max(0, targetAC - 10 - derivedStats.abilityModifiers.dex);\r\n        }\r\n    }\r\n\r\n    if (!derivedStats.hitDice) {\r\n        //Like AC bonuses, we calculate hit dice by extrapolating a target HP number and working backwards rather than extrapolating hit dice directly\r\n        let hpBenchmarks = findBenchmarksForStat([\"size\", \"con\", \"hitDice\"], targetCR, selectedMonster);\r\n        for (let benchmark in hpBenchmarks) {\r\n            let currentBenchmark = hpBenchmarks[benchmark];\r\n            currentBenchmark.hp = Math.floor(hitPointsPerHitDie(currentBenchmark) * currentBenchmark.hitDice);\r\n        }\r\n        let targetHP = extrapolateFromBenchmark('hp', targetCR, hpBenchmarks, false);\r\n        let hpPerHD = hitPointsPerHitDie(derivedStats);\r\n        derivedStats.hitDice = Math.max(1, Math.round(targetHP / hpPerHD));\r\n    }\r\n\r\n    //Find all attacks the creature should have at the target CR by adding locked attacks to attacks for all CRs equal to or below target\r\n    derivedStats.attacks = {};\r\n    if (selectedMonster.lockedStats && selectedMonster.lockedStats.attacks) {\r\n        for (let attack in selectedMonster.lockedStats.attacks) {\r\n            derivedStats.attacks[attack] = Object.assign({}, selectedMonster.lockedStats.attacks[attack]);\r\n        }\r\n    }\r\n    for (let cr in selectedMonster.stats) {\r\n        if (parseFloat(cr) <= parseFloat(targetCR) && selectedMonster.stats[cr].attacks) {\r\n            for (let attack in selectedMonster.stats[cr].attacks) {\r\n                if (!derivedStats.attacks[attack]) {\r\n                    //We want to copy the attack except for its damage, as that may need to be adjusted based on CR\r\n                    let attackCopy = Object.assign({}, selectedMonster.stats[cr].attacks[attack]);\r\n                    delete attackCopy.damageDice;\r\n                    delete attackCopy.damageDieSize;\r\n                    derivedStats.attacks[attack] = attackCopy;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    for (let attack in derivedStats.attacks) {\r\n        let currentAttack = derivedStats.attacks[attack];\r\n        //Ensure we are using appropriate stats for the target CR, if they are present\r\n        if (selectedMonster.stats[targetCR] && selectedMonster.stats[targetCR].attacks && selectedMonster.stats[targetCR].attacks[attack]) {\r\n            derivedStats.attacks[attack] = Object.assign(derivedStats.attacks[attack], selectedMonster.stats[targetCR].attacks[attack]);\r\n        }\r\n\r\n        //Fill in the gaps by extrapolating any missing attributes (such as attack damage)\r\n        if (!currentAttack.damageDice) {\r\n            let damageDiceString = 'attacks__'+attack+'__damageDice';\r\n            let damageDieString =  'attacks__'+attack+'__damageDieSize';\r\n            let attributes = ['str', damageDiceString, damageDieString];\r\n            if (currentAttack.finesse) {\r\n                attributes.push('dex');\r\n            }\r\n            let damageBenchmarks = findBenchmarksForStat(attributes, targetCR, selectedMonster);\r\n            for (let benchmark in damageBenchmarks) {\r\n                let currentBenchmark = damageBenchmarks[benchmark];\r\n                currentBenchmark.damagePerRound = averageRoll(currentBenchmark[damageDiceString], currentBenchmark[damageDieString]);\r\n                currentBenchmark.damagePerRound +=  abilityScoreModifier(currentAttack.finesse ? Math.max(currentBenchmark.str, currentBenchmark.dex) : currentBenchmark.str);\r\n            }\r\n            let estimatedDamage = extrapolateFromBenchmark('damagePerRound', targetCR, damageBenchmarks, false);\r\n            let targetDamage = estimatedDamage - (currentAttack.finesse ? Math.max(derivedStats.abilityModifiers.str, derivedStats.abilityModifiers.dex) : derivedStats.abilityModifiers.str);\r\n            //console.log(targetDamage);\r\n            let preferredDieSize = findNearestLowerBenchmark(damageDieString, targetCR, selectedMonster);\r\n            let estimatedDice = findDamageDice(targetDamage, preferredDieSize);\r\n            currentAttack.damageDice = estimatedDice[0];\r\n            currentAttack.damageDieSize = estimatedDice[1];\r\n        }\r\n\r\n        if (currentAttack.ranged && !currentAttack.range) {\r\n            currentAttack.range = findNearestLowerBenchmark('attacks__'+attack+'__range', targetCR, selectedMonster);\r\n            currentAttack.longRange = findNearestLowerBenchmark('attacks__'+attack+'__longRange', targetCR, selectedMonster);\r\n        }\r\n    }\r\n\r\n    //console.log(JSON.stringify(derivedStats));\r\n\r\n    //Once we have all the stats populate the statblock:\r\n    $('#monster-name').html(findNearestLowerBenchmark(\"name\", targetCR, selectedMonster));\r\n    $('#monster-type').html(sizes[derivedStats.size].name + ' ' + selectedMonster.type + ', ' + selectedMonster.alignment);\r\n\r\n    if (derivedStats.bonusArmor) {\r\n        $('#armor-class span').html((10 + derivedStats.bonusArmor + derivedStats.abilityModifiers.dex) + ' ('+derivedStats.armorDescription+')');\r\n    } else {\r\n        $('#armor-class span').html(10 + derivedStats.abilityModifiers.dex);\r\n    }\r\n    $('#hit-points span').html(Math.floor(hitPointsPerHitDie(derivedStats)*derivedStats.hitDice)+' ('+derivedStats.hitDice+'d'+sizes[derivedStats.size].hitDie+'+'+(derivedStats.abilityModifiers.con*derivedStats.hitDice)+')');\r\n    $('#speed span').html(findNearestLowerBenchmark('speed', targetCR, selectedMonster) + ' ft.');\r\n\r\n    for (let i = 0; i < abilityScores.length; i++) {\r\n        let abilityScore = abilityScores[i];\r\n        let modifier = abilityScoreModifier(derivedStats[abilityScore]);\r\n        let modifierString = \"(\" + (modifier >= 0 ? '+' : '') + modifier + \")\";\r\n       $('#monster-'+abilityScore).html(derivedStats[abilityScore] + \" \" + modifierString);\r\n    }\r\n\r\n    //TODO: When we add homebrow monsters we may need to account for creatures that gain new skills as they go up in CR.\r\n    if (derivedStats.skills) {\r\n        $('#skills').show();\r\n        let skillString = \"\";\r\n        for (let i = 0; i < derivedStats.skills.length; i ++) {\r\n            if (i > 0) {\r\n                skillString += ', ';\r\n            }\r\n            let skillModifier = averageStats[targetCR].proficiency + derivedStats.abilityModifiers[skills[derivedStats.skills[i]]];\r\n            let modifierString = (skillModifier >= 0 ? '+' : '') + skillModifier;\r\n            skillString+= toSentenceCase(derivedStats.skills[i]) + ' ' + modifierString;\r\n        }\r\n        $('#skills span').html(skillString);\r\n    } else {\r\n        $('#skills').hide();\r\n    }\r\n\r\n    //TODO: Add additional senses\r\n    let passivePerceptionString = 'passive Perception ' + (10 + derivedStats.abilityModifiers.wis + (derivedStats.skills && derivedStats.skills.includes('perception') ? averageStats[targetCR].proficiency : 0));\r\n    $('#senses span').html(passivePerceptionString);\r\n\r\n    $('#challenge-rating span').html(stringForCR(targetCR) + ' (' + averageStats[targetCR].xp.toLocaleString() + ' XP)');\r\n\r\n    $('#traits').empty();\r\n    if (derivedStats.traits) {\r\n        for (let traitName in derivedStats.traits) {\r\n            let currentTrait = derivedStats.traits[traitName];\r\n            $('<p><strong><em>'+currentTrait.name+'.</em></strong> '+replaceTokensInString(currentTrait.description, derivedStats, currentTrait)+'</p>').appendTo('#traits');\r\n        }\r\n    }\r\n\r\n    $('#attacks').empty();\r\n    if (derivedStats.multiattack) {\r\n        if (Object.keys(derivedStats.multiattack.attacks).length > 1) {\r\n            //Text reads differently if there are multiple different attack types\r\n            let attackCount = 0;\r\n            let multiattackString = \"\";\r\n            let attacks = Object.keys(derivedStats.multiattack.attacks);\r\n            for (let i = 0; i < attacks.length; i++) {\r\n                attackCount += derivedStats.multiattack.attacks[attacks[i]];\r\n                multiattackString += numberStrings[derivedStats.multiattack.attacks[attacks[i]]] + ' with its ' + derivedStats.attacks[attacks[i]].name.toLowerCase();\r\n                if (i < attacks.length - 2) {\r\n                    //Separate attacks with commas\r\n                    multiattackString += ', ';\r\n                } else if (i == attacks.length - 2) {\r\n                    //Add \"and\" before last attack. Add an oxford comma, but only if there are more than two types of attacks.\r\n                    multiattackString += (attacks.length > 2 ? ',' : '') + ' and ';\r\n                }\r\n            }\r\n            multiattackString = '<strong>Multiattack:</strong> The ' + derivedStats.slug + ' makes ' + numberStrings[attackCount] + ' attacks:' + multiattackString + '.';\r\n            if (derivedStats.multiattack.requireDifferentTargets) {\r\n                //This may need to change if a creature with more than two attacks ever gets this attribute, but for now it's fine as is as only the t rex has this restriction\r\n                multiattackString+= ' It can&rsquo;t make both attacks against the same target.';\r\n            }\r\n            $('<p>'+multiattackString+'</p>').appendTo('#attacks');\r\n        } else {\r\n            let attack = Object.keys(derivedStats.multiattack.attacks)[0];\r\n            let multiattackString = '<strong>Multiattack:</strong> The ' + derivedStats.slug + ' makes ' + numberStrings[derivedStats.multiattack.attacks[attack]] + ' ' + derivedStats.attacks[attack].name.toLowerCase() + ' attacks.';\r\n            $('<p>'+multiattackString+'</p>').appendTo('#attacks');\r\n        }\r\n        \r\n    }\r\n    if (derivedStats.attacks) {\r\n        for (let attack in derivedStats.attacks) {\r\n            let currentAttack = derivedStats.attacks[attack];\r\n            let attackString = '<strong>'+currentAttack.name+'.</strong> ';\r\n            attackString += '<em>' + (currentAttack.ranged ? 'Ranged' : 'Melee') + ' Weapon Attack:</em> ';\r\n            let abilityModifier = currentAttack.finesse ? Math.max(derivedStats.abilityModifiers.str, derivedStats.abilityModifiers.dex) : derivedStats.abilityModifiers.str;\r\n            let rangeString;\r\n            if (currentAttack.ranged) {\r\n                rangeString = 'range ' + currentAttack.range + (currentAttack.longRange ? '/' + currentAttack.longRange : '');\r\n            } else {\r\n                rangeString = 'reach ' + sizes[derivedStats.size].reach[currentAttack.reach];\r\n            }\r\n            attackString += '+' + (derivedStats.proficiency + abilityModifier) + ' to hit, '+rangeString+ ' ft., one target. ';\r\n            attackString += '<em>Hit:</em> ' + Math.max(1, (averageRoll(currentAttack.damageDice, currentAttack.damageDieSize) + abilityModifier));\r\n            attackString += ' (' + currentAttack.damageDice + 'd' + currentAttack.damageDieSize + (abilityModifier >= 0 ? ' + ' : ' - ' ) + Math.abs(abilityModifier) + ') ' + currentAttack.damageType + ' damage.';\r\n            if (currentAttack.proc) {\r\n                attackString+= ' ' + replaceTokensInString(procs[currentAttack.proc], derivedStats);\r\n            }\r\n            $('<p>'+attackString+'</p>').appendTo('#attacks');\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Converts challenge rating to a \"step\" so that fractional CRs carry the same weight in scaling as full number CRs.\r\n *\r\n * @param {string} cr The challenge rating to convert to a step.\r\n * @return {number} The relative step for the challenge rating.\r\n */\r\nfunction stepForCR(cr) {\r\n    //Fractional CRs are counted as a full step in calculations, ie going from CR 1/8 to 1/4 carries as much weight as going from CR 1 to 2.\r\n    let safeCR = parseFloat(cr);\r\n    switch(safeCR) {\r\n        case 0:\r\n            return 0;\r\n        case 0.125:\r\n            return 1;\r\n        case 0.25:\r\n            return 2;\r\n        case 0.5: \r\n            return 3;\r\n        default:\r\n            return safeCR+3;\r\n    }\r\n}\r\n\r\n/**\r\n * Converts challenge rating to a string so that decimal CRs become fractions\r\n *\r\n * @param {string} cr The challenge rating to convert to a string.\r\n * @return {string} The string version of the challenge rating\r\n */\r\n function stringForCR(cr) {\r\n    let safeCR = parseFloat(cr);\r\n    switch(safeCR) {\r\n        case 0.125:\r\n            return '1/8';\r\n        case 0.25:\r\n            return '1/4';\r\n        case 0.5: \r\n            return '1/2';\r\n        default:\r\n            return cr;\r\n    }\r\n}\r\n\r\n/**\r\n * Finds the closest statblocks above and below the target CR that have the target stat(s)\r\n *\r\n * @param {Array} stats The stats to search for\r\n * @param {string} targetCR The challenge rating to find benchmarks for\r\n * @param {Object} selectedMonster The monster template for which to find stat benchmarks\r\n * @return {Object} Benchmarks for the selected stat at the nearest CRs above and below it that had values for that stat.\r\n */\r\nfunction findBenchmarksForStat(stats, targetCR, selectedMonster) {\r\n    let numTargetCR = Number(targetCR); //CRs must be compared as ints or the equality checks sometimes return the wrong result\r\n    let statList = Array.isArray(stats) ? stats : [stats];\r\n    let benchmarks = null;\r\n    for (let cr in selectedMonster.stats) {\r\n        let numCR = Number(cr);\r\n        let statBlock = flattenObject(selectedMonster.stats[cr]);\r\n        let allStatsFound = true;\r\n        for (let i = 0; i < statList.length; i++) {\r\n            allStatsFound = allStatsFound && statBlock.hasOwnProperty(statList[i]);\r\n            if (!allStatsFound) {\r\n                break;\r\n            }\r\n        }\r\n        if (allStatsFound) {\r\n            if (!benchmarks) {\r\n                benchmarks = {};\r\n            }\r\n            if (numCR > numTargetCR) {\r\n                if (!benchmarks.upper || benchmarks.upper.cr > numCR) {\r\n                    benchmarks.upper = {\r\n                        cr: numCR,\r\n                    }\r\n                    for (let i = 0; i < statList.length; i++) {\r\n                        benchmarks.upper[statList[i]] = statBlock[statList[i]];\r\n                    }\r\n                }\r\n            } else {\r\n                if (!benchmarks.lower || benchmarks.lower.cr < numCR) {\r\n                    benchmarks.lower = {\r\n                        cr: numCR,\r\n                    }\r\n                    for (let i = 0; i < statList.length; i++) {\r\n                        benchmarks.lower[statList[i]] = statBlock[statList[i]];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return benchmarks;\r\n}\r\n\r\n/**\r\n * Finds the closest statblocks above and below the target CR that have the target stat\r\n *\r\n * @param {string} stat The stat to extrapolate\r\n * @param {string} targetCR The challenge rating to find benchmarks for\r\n * @param {Object} benchmarks The upper and/or lower benchmarks to extrapolate from\r\n * @param {boolean} linearExtrapolation If true the extrapolation will be an offset instead of a ratio.\r\n *  For example, a template with a value of 5 when the average stat is 4 would result in an offset of +1 instead of a multiplier of *1.2.\r\n * @return {Number} The extrapolated value\r\n */\r\nfunction extrapolateFromBenchmark(stat, targetCR, benchmarks, linearExtrapolation) {\r\n    //If a benchmark was only found in one direction we simply use that benchmark to extrapolate a state for the target CR\r\n    //If benchmarks were found above and below, we calculate the target result for BOTH benchmarks, then take a weighted average based on which is closer\r\n    //So if the upper benchmark is 1 step away, and the lower benchmark is 4 steps away, then the upper will count for 80% of the average\r\n    let upperValue, lowerValue;\r\n    if (benchmarks.upper) {\r\n        if (linearExtrapolation) {\r\n            let offset = benchmarks.upper[stat] - averageStats[benchmarks.upper.cr][stat];\r\n            upperValue = offset + averageStats[targetCR][stat];\r\n        } else {\r\n            let ratio = benchmarks.upper[stat] / averageStats[benchmarks.upper.cr][stat];\r\n            upperValue = ratio * averageStats[targetCR][stat];\r\n        }\r\n    }\r\n    if (benchmarks.lower) {\r\n        if (linearExtrapolation) {\r\n            let offset = benchmarks.lower[stat] - averageStats[benchmarks.lower.cr][stat];\r\n            lowerValue = offset + averageStats[targetCR][stat];\r\n        } else {\r\n            let ratio = benchmarks.lower[stat] / averageStats[benchmarks.lower.cr][stat];\r\n            lowerValue = ratio * averageStats[targetCR][stat];\r\n        }\r\n    }\r\n\r\n    if (lowerValue) {\r\n        if (upperValue) {\r\n            //If upper and lower take a weighted average\r\n            let upperStep = stepForCR(benchmarks.upper.cr);\r\n            let lowerStep = stepForCR(benchmarks.lower.cr);\r\n            let stepRange = upperStep - lowerStep;\r\n            let targetStep = stepForCR(targetCR);\r\n            let upperWeight = (upperStep - targetStep) / stepRange;\r\n            let lowerWeight = (targetStep - lowerStep) / stepRange;\r\n            return Math.round(upperWeight * upperValue + lowerWeight * lowerValue);\r\n        }\r\n        return Math.round(lowerValue);\r\n    }\r\n    return Math.round(upperValue);\r\n}\r\n\r\n/**\r\n * Calculates the modifier for an ability score\r\n *\r\n * @param {string} ability The ability score value\r\n * @return {number} The ability score modifier\r\n */\r\n function abilityScoreModifier(ability) {\r\n    return Math.floor((ability - 10) / 2);\r\n}\r\n\r\n/**\r\n * Calculates the weighted average for a state between two CRs, ie if benchmarks are found for one CR below and 4 CR above, an average weighted toward the lower benchmark will be calculated\r\n *\r\n * @param {string} stat The name of the stat to average.\r\n * @param {Object} benchmarks The benchmarks to average from.\r\n * @return {number} The weighted average value\r\n */\r\n function calculateWeightedAverage(stat, benchmarks, targetCR) {\r\n    let upperStep = stepForCR(benchmarks.upper.cr);\r\n    let lowerStep = stepForCR(benchmarks.lower.cr);\r\n    let stepRange = upperStep - lowerStep;\r\n    let targetStep = stepForCR(targetCR);\r\n    let upperWeight = (upperStep - targetStep) / stepRange;\r\n    let lowerWeight = (targetStep - lowerStep) / stepRange;\r\n    return Math.round(upperWeight * benchmarks.upper[stat] + lowerWeight * benchmarks.lower[stat]);\r\n}\r\n\r\n\r\n/**\r\n * Calculates the hit dice per hit die for a creature\r\n *\r\n * @param {Object} statblock The statblock. Must have size and con\r\n * @return {number} The number of hit points\r\n */\r\n function hitPointsPerHitDie(statblock) {\r\n    return ((sizes[statblock.size].hitDie + 1) / 2) + abilityScoreModifier(statblock.con);\r\n}\r\n\r\n/**\r\n * Finds the closest benchmark that is below the target CR. If there are none then it returns the lowest benchmark.\r\n *\r\n * @param {string} stat The stat to search for\r\n * @param {string} targetCR The target challenge rating\r\n * @param {Object} selectedMonster The monster to search \r\n * @return {number} The number of hit points\r\n */\r\n function findNearestLowerBenchmark(stat, targetCR, selectedMonster) {\r\n    let numTargetCR = parseFloat(targetCR);\r\n    let statList = selectedMonster.stats;\r\n    let lowestValue;\r\n    let lowestCR = 31;\r\n    let highestValue;\r\n    let highestCR = 0;\r\n    for (let cr in statList) {\r\n        let numCR = parseFloat(cr);\r\n        let statBlock = flattenObject(statList[cr]);\r\n        if (statBlock[stat]) {\r\n            if (numCR < lowestCR) {\r\n                lowestCR = cr;\r\n                lowestValue = statBlock[stat];\r\n            }\r\n            if (numCR > highestCR && numCR <= numTargetCR) {\r\n                highestValue = statBlock[stat];\r\n                highestCR = cr;\r\n            }\r\n        }\r\n    }\r\n    return highestValue != null ? highestValue : lowestValue;\r\n}\r\n\r\n/**\r\n * Returns a sentence case version of a string\r\n *\r\n * @param {string} targetString The string to convert to sentence case\r\n * @return {string} The sentence case string\r\n */\r\n function toSentenceCase(targetString) {\r\n    return targetString[0].toUpperCase() + targetString.substr(1);\r\n }\r\n \r\n /**\r\n * Replaced various tokens in a string with appropriate values\r\n *\r\n * @param {string} targetString The string in which to find and replace tokens\r\n * @param {Object} statBlock The statblock to use when replacing stat related tokens, such as save DCs\r\n * @param {Object} trait Secondary stat block for a specific trait, which is used when determing trait related tokens\r\n * @return {string} The result string with tokens replaced\r\n */\r\n  function replaceTokensInString(targetString, statBlock, trait) {\r\n    let outputString = targetString;\r\n    while (outputString.indexOf('{{') >= 0) {\r\n        let tokenStartIndex = outputString.indexOf('{{');\r\n        let tokenEndIndex = outputString.indexOf('}}')+2;\r\n        let fullToken = outputString.substr(tokenStartIndex,tokenEndIndex-tokenStartIndex);\r\n        let token = fullToken.substr(2, fullToken.length-4);\r\n        let tokenValue = '';\r\n\r\n        if (statBlock[token]) {\r\n            tokenValue = statBlock[token];\r\n        } else {\r\n            let tokenArray = token.split(':');\r\n            if (tokenArray[0] == 'DC') {\r\n                let dc =  8 + statBlock.proficiency + statBlock.abilityModifiers[tokenArray[1]];\r\n                if (tokenArray.length > 2) {\r\n                    dc += parseInt(tokenArray[2]);\r\n                }\r\n                tokenValue = dc;\r\n            } else if (tokenArray[0] == 'size') {\r\n                let targetSize = statBlock.size + parseInt(tokenArray[1]);\r\n                tokenValue = sizes[targetSize].name;\r\n            } else if (tokenArray[0] == 'trait') {\r\n                if (tokenArray[1] == 'DC') {\r\n                    let dc =  8 + statBlock.proficiency + statBlock.abilityModifiers[trait.dcStat];\r\n                    if (trait.dcAdjustment) {\r\n                        dc += parseInt(trait.dcAdjustment);\r\n                    }\r\n                    tokenValue = dc;\r\n                }\r\n            }\r\n        }\r\n\r\n        outputString = outputString.replace(fullToken, tokenValue);\r\n    } \r\n    return outputString;\r\n }\r\n\r\n /**\r\n * Recursively flattens and object. ie, {x: {y:5}, z: 10} would become {x__y : 5, z : 10}\r\n *\r\n * @param {Object} targetObject The object to flatten\r\n * @return {Object} The flattened object\r\n */\r\n  function flattenObject(targetObject) {\r\n    let outputObject = {};\r\n    for (let property in targetObject) {\r\n        let value = targetObject[property];\r\n        if (typeof(value) == 'object') {\r\n            let flattenedChild = flattenObject(value);\r\n            for (let childProperty in flattenedChild) {\r\n                outputObject[property+'__'+childProperty] = flattenedChild[childProperty];\r\n            }\r\n        } else {\r\n            outputObject[property] = value;\r\n        }\r\n    }\r\n    return outputObject;\r\n}\r\n\r\n /**\r\n * Returns the average roll for a number of dice\r\n *\r\n * @param {Number} diceCount The number of dice to roll\r\n * @param {Number} dieSize The size of the dice being rolled\r\n * @return {Number} The average roll, rounded down\r\n */\r\n  function averageRoll(diceCount, dieSize) {\r\n      let averagePerDie = (1 + dieSize) / 2;\r\n      return Math.floor(diceCount * averagePerDie);\r\n  }\r\n\r\n/**\r\n * Returns an appropriate damage die size and count to reach an estiamted average damage number\r\n *\r\n * @param {Number} targetDamage The target average damage\r\n * @param {Number} preferredDieSize The preferred die size to return, usually the monster's original damage die. This will be used unless the target number so low a single die is too much, or so high that this would result in an excessive number of dice\r\n * @return {Array} An array containing number of dice at index 0 and die size at index 1\r\n */\r\nfunction findDamageDice(targetDamage, preferredDieSize) {\r\n    //TODO: Consider capping damage dice for specific attacks and split high damage attacks into multiattacks\r\n    //This method tries to find the damage die that would yield the best average damage, but favors larger dice so mosnters don't all end up using loads of d4s.\r\n    let maximumDice = 15; //If the number of dice exceeds this the next step up will be used, unless the die size is already d12.\r\n    let dice = [12, 10, 8, 6, 4];\r\n    let dieAverages = [6.5, 5.5, 4.5, 3.5, 2.5];\r\n    //If the preferred die is a larger one make sure that a single die is not too much.\r\n    //For example, if a creature with d12 attacks is scaled down to CR 0 even 1d12 may be too much average damage\r\n    if (targetDamage < dieAverages[dice.indexOf(preferredDieSize)] - .5) {\r\n        //If target damage is closer to a lower average then the preferred die size is too high\r\n        let desiredAverage = Math.floor(targetDamage) + .5; //Round and add .5 to make it match a die average\r\n        desiredAverage = Math.max(desiredAverage, 2.5); //Make sure it's at least the average for a d4 in case it's a very low number\r\n        return [1, dice[dieAverages.indexOf(desiredAverage)]];        \r\n\r\n    }\r\n\r\n    let dieCount = Math.round(targetDamage/dieAverages[dice.indexOf(preferredDieSize)]);\r\n    let dieSize = preferredDieSize;\r\n    while (dieCount > maximumDice && dieSize < 12) {\r\n        dieSize = dice[dice.indexOf(dieSize)-1];\r\n        dieCount = Math.round(targetDamage/dieAverages[dice.indexOf(dieSize)]);\r\n    }\r\n    return [dieCount, dieSize];\r\n}"],"names":["numberStrings","$","monster","monsterList","toSentenceCase","appendTo","location","search","length","params","URLSearchParams","paramMonster","get","paramsCR","val","on","calculateSelectedMonster","monsterID","selectedMonster","targetCR","directLink","toString","replace","attr","derivedStats","Object","assign","lockedStats","stats","proficiency","averageStats","slug","findNearestLowerBenchmark","traits","i","traitName","baseTrait","newTrait","name","description","allowsSave","dcStat","hasOwnProperty","dcAdjustmentString","dcAdjustmentBenchmarks","findBenchmarksForStat","upper","lower","dcAdjustment","calculateWeightedAverage","size","sizeBenchmarks","extrapolateFromBenchmark","Math","min","abilityScores","abilityModifiers","abilityBenchmarks","abilityScoreModifier","bonusArmor","acBenchmarks","benchmark","ac","dex","targetAC","max","hitDice","hpBenchmarks","currentBenchmark","hp","floor","hitPointsPerHitDie","targetHP","hpPerHD","round","attacks","attack","cr","parseFloat","attackCopy","damageDice","damageDieSize","currentAttack","damageDiceString","damageDieString","attributes","finesse","push","damageBenchmarks","damagePerRound","averageRoll","str","estimatedDamage","targetDamage","preferredDieSize","estimatedDice","findDamageDice","ranged","range","longRange","html","sizes","type","alignment","armorDescription","hitDie","con","abilityScore","modifier","modifierString","skills","show","skillString","skillModifier","hide","passivePerceptionString","wis","includes","stringForCR","xp","toLocaleString","empty","currentTrait","replaceTokensInString","multiattack","keys","attackCount","multiattackString","toLowerCase","requireDifferentTargets","attackString","abilityModifier","rangeString","reach","abs","damageType","proc","procs","stepForCR","safeCR","numTargetCR","Number","statList","Array","isArray","benchmarks","numCR","statBlock","flattenObject","allStatsFound","stat","linearExtrapolation","upperValue","lowerValue","offset","ratio","upperStep","lowerStep","stepRange","targetStep","upperWeight","lowerWeight","ability","statblock","lowestValue","lowestCR","highestValue","highestCR","targetString","toUpperCase","substr","trait","outputString","indexOf","tokenStartIndex","tokenEndIndex","fullToken","token","tokenValue","tokenArray","split","dc","parseInt","targetSize","targetObject","outputObject","property","value","flattenedChild","childProperty","diceCount","dieSize","averagePerDie","maximumDice","dice","dieAverages","desiredAverage","dieCount"],"mappings":"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"}